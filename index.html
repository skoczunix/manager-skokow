<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Pro Manager Skok√≥w - ULTIMATE SECURE V22 (Live Sync & Records Fix)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --primary: #003366; --accent: #cc0000; --live: #28a745; --light: #f4f7f6; --gold: #ffd700; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--light); color: #333; }
        .admin-bar { background: #222; color: white; padding: 10px 25px; display: flex; justify-content: space-between; align-items: center; }
        nav { background: var(--primary); padding: 12px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        nav button { background: transparent; border: 1px solid rgba(255,255,255,0.5); color: white; padding: 8px 15px; cursor: pointer; border-radius: 6px; font-weight: bold; }
        header { background: linear-gradient(to bottom, var(--primary), #001a33); color: white; padding: 30px; text-align: center; }
        .container { max-width: 1200px; margin: 25px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: center; vertical-align: middle; word-wrap: break-word; font-size: 0.9rem; }
        th { background: var(--primary); color: white; }
        
        /* Styl zaznaczania dla admina */
        td[contenteditable="true"]:focus { outline: 2px solid var(--gold); background: #fffdf0; }
        
        .col-rank { width: 55px; }
        .col-name { width: auto; }
        .col-score { width: 75px; }
        .col-total { width: 90px; font-weight: bold; }
        .col-action { width: 55px; }

        .hidden { display: none !important; }
        .btn { padding: 8px 15px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; }
        .btn-add { background: var(--live); color: white; margin-bottom: 20px; }
        .btn-del { background: var(--accent); color: white; padding: 5px 10px; font-size: 0.8rem; border-radius: 4px; }
        .btn-action { background: #ff9800; color: white; margin-left: 10px; }
        
        .card { background: #f8f9fa; border: 1px solid #ddd; border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .live-info { background: #fff3cd; border-left: 5px solid #ffc107; padding: 15px; margin-bottom: 15px; font-weight: bold; text-align: center; border-radius: 8px; font-size: 1.2rem; }
        .q-badge { color: #00ff00; font-weight: bold; margin-left: 5px; font-size: 0.85rem; background: rgba(0,255,0,0.1); padding: 2px 5px; border-radius: 4px; border: 1px solid #00ff00; }
        .editable-cell { background: #fff9e6; border: 1px dashed #ffc107 !important; outline: none; }

        .dropdown-wrapper { position: relative; width: 100%; }
        .search-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.9rem; }
        .suggestions-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; z-index: 9999; max-height: 200px; overflow-y: auto; display: none; text-align: left; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .suggestion-item:hover { background: #f0f0f0; }

        .event-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .event-card { background: #fff; border: 1px solid #ddd; border-radius: 12px; padding: 15px; text-align: center; border-top: 5px solid #ccc; cursor: pointer; transition: transform 0.2s; }
        .event-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .stat-details { font-size: 0.8rem; text-align: left; background: #fff; border: 1px solid #eee; padding: 8px; margin-top: 8px; border-radius: 6px; display: none; max-height: 150px; overflow-y: auto; }
        .stat-bar-container { background: #eee; border-radius: 4px; height: 12px; width: 100%; margin-top: 5px; overflow: hidden; }
        .stat-bar-fill { background: var(--primary); height: 100%; }

        .login-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 10000; display:flex; justify-content:center; align-items:center; }
        .login-box { background: white; padding: 30px; border-radius: 10px; width: 300px; text-align: center; }
        .login-input { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="admin-bar">
    <div id="status">Status: üîµ ≈ÅƒÖczenie...</div>
    <div id="user-info" class="hidden" style="margin-right:15px; font-size:0.9rem; color:#aaa;">Zalogowany</div>
    <button id="auth-btn" class="btn" style="background: var(--accent); color:white;" onclick="handleAuthClick()">Admin (Logowanie)</button>
</div>

<nav>
    <button onclick="showPage('page-home')">üè† SEZONY</button>
    <button onclick="showPage('page-skoczkowie')">‚õ∑Ô∏è SKOCZKOWIE</button>
    <button onclick="showPage('page-skocznie')">üèîÔ∏è SKOCZNIE</button>
    <button onclick="showPage('page-records-main')">üéñÔ∏è REKORDY</button>
</nav>

<header><h1>System Skok√≥w Narciarskich</h1></header>

<div id="login-modal" class="login-overlay hidden">
    <div class="login-box">
        <h2>Panel Admina</h2>
        <input type="email" id="login-email" class="login-input" placeholder="Email">
        <input type="password" id="login-pass" class="login-input" placeholder="Has≈Ço">
        <button class="btn" style="background:var(--primary); color:white; width:100%;" onclick="performLogin()">Zaloguj siƒô</button>
        <button class="btn" style="background:#ccc; color:#333; width:100%; margin-top:10px;" onclick="document.getElementById('login-modal').classList.add('hidden')">Anuluj</button>
    </div>
</div>

<div class="container">
    <div id="page-home">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <h2>Lista Sezon√≥w</h2>
                <button class="btn btn-add admin-only hidden" onclick="addSeason()">+ Nowy Sezon</button>
                <div id="seasons-list"></div>
            </div>
            <div class="admin-only hidden">
                <h2>Klasyfikacje Globalne</h2>
                <div id="global-standings-admin-list"></div>
                <div class="card">
                    <input type="text" id="global-st-name" class="search-input" placeholder="Nazwa Rankingu">
                    <select id="global-st-type" class="search-input" style="margin:5px 0;"><option value="fis">FIS (PunktujƒÖ tylko Q)</option><option value="notes">Suma Not (Wszyscy)</option></select>
                    <button class="btn btn-add" onclick="createGlobalStanding()">DODAJ RANKING</button>
                </div>
            </div>
        </div>
    </div>

    <div id="page-skocznie" class="hidden">
        <h2>Baza Skoczni</h2>
        <div class="admin-only hidden card">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input type="text" id="h-name-base" class="search-input" placeholder="Nazwa (np. Wis≈Ça)">
                <input type="number" id="h-hs-val" class="search-input" placeholder="HS">
                <input type="number" id="h-k-val" class="search-input" placeholder="K">
                <div class="dropdown-wrapper">
                    <input type="text" id="h-rk-auth" class="search-input" placeholder="Rekordzista KoGama" oninput="filterLocalList(this, 'suggestions-h-rk')">
                    <div id="suggestions-h-rk" class="suggestions-list"></div>
                </div>
                <input type="text" id="h-rk-dist" class="search-input" placeholder="Rekord KoGama (m)">
                <input type="text" id="h-rr-auth" class="search-input" placeholder="Real Kto">
                <input type="text" id="h-rr-dist" class="search-input" placeholder="Real Metry">
            </div>
            <button class="btn btn-add" style="margin-top:10px;" onclick="addHill()">+ Dodaj Skoczniƒô</button>
        </div>
        <table><thead><tr><th>Nazwa</th><th>Parametry</th><th>Rekord KoGama</th><th>Rekord Realny</th><th class="admin-only hidden">X</th></tr></thead><tbody id="hill-list"></tbody></table>
    </div>

    <div id="page-calendar" class="hidden">
        <button class="btn" onclick="showPage('page-season-tiles')">‚Üê Powr√≥t</button>
        <h2>Kalendarz Sezonu</h2>
        <button class="btn btn-add admin-only hidden" onclick="addNewCompetitionDirectly()">+ DODAJ KONKURS</button>
        <table><thead><tr><th>Data</th><th>Rodzaj</th><th>Skocznia</th><th>Akcja</th></tr></thead><tbody id="calendar-body"></tbody></table>
    </div>

    <div id="page-results" class="hidden">
        <button class="btn" style="background:#666; color:white;" onclick="showPage('page-calendar')">‚Üê Powr√≥t</button>
        <h2 id="current-comp-title">...</h2>
        <div id="live-to-beat" class="live-info">Oczekiwanie na decyzjƒô sƒôdzi√≥w...</div>
        <div class="admin-only hidden card" style="display:flex; gap:20px; align-items:center; background:#fff9e6; border:1px solid orange;">
            <div>Limit Q: <input type="number" id="q-limit-input" value="30" style="width:60px;" oninput="updateQLimit(this.value)"></div>
            <div id="global-checkboxes"></div>
        </div>
        <button id="add-result-btn" class="btn btn-add admin-only hidden" onclick="addResultRow()">+ Skoczek</button>
        <table><thead><tr><th class="col-rank">Poz.</th><th class="col-name">Zawodnik</th><th class="col-score">S1</th><th class="s2-col col-score">S2</th><th class="msl-extra hidden col-score">S3</th><th class="msl-extra hidden col-score">S4</th><th class="col-total">Nota</th><th class="admin-only hidden col-action">X</th></tr></thead><tbody id="results-body"></tbody></table>
    </div>

    <div id="page-profile" class="hidden">
        <button class="btn" onclick="showPage('page-skoczkowie')">‚Üê Powr√≥t</button>
        <h1 id="prof-name">...</h1>
        <div class="event-grid">
            <div class="event-card" onclick="toggleStatList('prof-wins')"><h4>üåç Wygrane P≈ö</h4><div id="c-wins">0</div><div id="prof-wins" class="stat-details"></div></div>
            <div class="event-card" onclick="toggleStatList('prof-pods')"><h4>ü•à Podia</h4><div id="c-pods">0</div><div id="prof-pods" class="stat-details"></div></div>
            <div class="event-card" onclick="toggleStatList('prof-io-list')"><h4>ü•á IO</h4><div id="c-io">0</div><div id="prof-io-list" class="stat-details"></div></div>
            <div class="event-card" onclick="toggleStatList('prof-ms-list')"><h4>üèÜ M≈ö</h4><div id="ms-count">0</div><div id="prof-ms-list" class="stat-details"></div></div>
            <div class="event-card" onclick="toggleStatList('prof-msl-list')"><h4>‚úàÔ∏è M≈öL</h4><div id="msl-count">0</div><div id="prof-msl-list" class="stat-details"></div></div>
        </div>
        <div class="card" style="margin-top:20px;">
            <h3>üìÖ Historia Start√≥w</h3>
            <table><thead><tr><th>Data</th><th>Miejsce</th><th>Poz.</th></tr></thead><tbody id="prof-history-10"></tbody><tbody id="prof-history-full" class="hidden"></tbody></table>
            <button class="btn" style="width:100%; margin-top:10px;" onclick="document.getElementById('prof-history-full').classList.toggle('hidden'); this.innerText = (this.innerText === 'Poka≈º wiƒôcej' ? 'Poka≈º mniej' : 'Poka≈º wiƒôcej')">Poka≈º wiƒôcej</button>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px;">
            <div class="card"><h3>üìä Dominacja (Wygrane)</h3><div id="prof-hills-chart"></div></div>
            <div class="card"><h3>üéñÔ∏è Rekordy i Tytu≈Çy</h3><div id="prof-special-records"></div><h3>üèîÔ∏è Moje Rekordy Skoczni</h3><div id="prof-rec-list" style="font-size:0.8rem;"></div></div>
        </div>
        <h3>üèÜ Klasyfikacje Ko≈Ñcowe (Archiwum)</h3>
        <div class="card" id="prof-final-records-global">Brak wpis√≥w archiwalnych.</div>
    </div>

    <div id="page-records-main" class="hidden">
        <h2>Rekordy Historyczne</h2>
        <div class="admin-only hidden card">
            <div style="display:flex; gap:10px;">
                <input type="text" class="search-input" id="rec-name-in" placeholder="Kto" style="width: 150px; flex-shrink: 0;">
                <input type="text" class="search-input" id="rec-text-in" placeholder="Tre≈õƒá rekordu..." style="flex-grow: 1;">
                <button class="btn btn-add" onclick="addSpecialRecord()">DODAJ</button>
            </div>
        </div>
        <div id="global-records-list"></div>
    </div>

    <div id="page-season-tiles" class="hidden"><button class="btn" onclick="showPage('page-home')">‚Üê Powr√≥t</button><h2 id="tiles-title">...</h2><div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;"><div class="card" onclick="showPage('page-calendar')"><h2>üìÖ Kalendarz</h2></div><div class="card" onclick="showPage('page-standings-selection')"><h2>üèÜ Klasyfikacje</h2></div></div></div>
    <div id="page-skoczkowie" class="hidden"><h2>Baza Skoczk√≥w</h2><button class="btn btn-add admin-only hidden" onclick="addSkoczek()">+ Dodaj</button><table><thead><tr><th>Imiƒô</th><th>Profil</th><th class="admin-only hidden">X</th></tr></thead><tbody id="skoczkowie-list"></tbody></table></div>
    <div id="page-standings-selection" class="hidden"><button class="btn" onclick="showPage('page-season-tiles')">‚Üê Powr√≥t</button><h2>Rankingi</h2><div id="standings-user-list"></div></div>
    <div id="page-standings-view" class="hidden">
        <button class="btn" onclick="showPage('page-standings-selection')">‚Üê Powr√≥t</button>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="st-view-title">Ranking</h2>
            <div class="admin-only hidden">
                <button class="btn btn-action" style="background:var(--accent);" onclick="finalizeStanding()">Zako≈Ñcz (Zapisz w profilach)</button>
                <button class="btn btn-action" style="background:var(--live);" onclick="resumeStanding()">Wzn√≥w (Usu≈Ñ z profili)</button>
            </div>
        </div>
        <div id="st-status-info" class="live-info hidden">Ten ranking zosta≈Ç zako≈Ñczony i zapisany.</div>
        <table><thead><tr id="st-view-head"></tr></thead><tbody id="st-view-body"></tbody></table>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAMUC3EoBk9e_2c9JDuctpLw9E5ift1--U",
        authDomain: "skoki-kogama.firebaseapp.com",
        databaseURL: "https://skoki-kogama-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "skoki-kogama",
        storageBucket: "skoki-kogama.firebasestorage.app",
        messagingSenderId: "140387723904",
        appId: "1:140387723904:web:911efb3631b2a8d1e4d465",
        measurementId: "G-ZDZNGNHPCY"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    
    let isAdmin = false, activeSeasonId = null, activeCompId = null, activeType = '';
    let globalSkoczkowie = [], globalHills = [];
    let currentStandingId = null; 

    const FIS_PTS = [100, 80, 60, 50, 45, 40, 36, 32, 29, 26, 24, 22, 20, 18, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1];
    
    // AUTHENTICATION LISTENER
    db.ref('.info/connected').on('value', s => { document.getElementById('status').innerHTML = s.val() ? "Status: üü¢ Po≈ÇƒÖczono" : "Status: üî¥ Roz≈ÇƒÖczono"; });
    
    // LIVE SYNC LISTENER (Wszyscy widzƒÖ co ustawi≈Ç admin)
    db.ref('status/liveToBeat').on('value', s => {
        const msg = s.val() || "Oczekiwanie na decyzjƒô sƒôdzi√≥w...";
        document.getElementById('live-to-beat').innerText = msg;
    });

    auth.onAuthStateChanged(user => {
        if (user) {
            isAdmin = true;
            document.getElementById('auth-btn').innerText = "Wyloguj";
            document.getElementById('auth-btn').style.background = "#555";
            document.getElementById('user-info').innerText = user.email;
            document.getElementById('user-info').classList.remove('hidden');
            document.getElementById('login-modal').classList.add('hidden');
        } else {
            isAdmin = false;
            document.getElementById('auth-btn').innerText = "Zaloguj (Admin)";
            document.getElementById('auth-btn').style.background = "var(--accent)";
            document.getElementById('user-info').classList.add('hidden');
        }
        updateAdminUI();
    });

    function handleAuthClick() {
        if (isAdmin) {
            auth.signOut().then(() => alert("Wylogowano.")).catch(e => alert(e.message));
        } else {
            document.getElementById('login-modal').classList.remove('hidden');
        }
    }

    function performLogin() {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;
        auth.signInWithEmailAndPassword(email, pass).catch(error => {
            alert("B≈ÇƒÖd logowania: " + error.message);
        });
    }

    function updateAdminUI() {
        document.querySelectorAll('.admin-only, .btn-add').forEach(el => el.classList.toggle('hidden', !isAdmin));
        if(activeSeasonId) db.ref('kalendarze/'+activeSeasonId).once('value', s => renderCalendar(Object.values(s.val()||{})));
        db.ref('skocznie').once('value', s => refreshHillList(Object.values(s.val()||{})));
        // Refresh records to show/hide delete buttons
        db.ref('osiagniecia_specjalne').once('value', s => refreshRecordsList(s.val()));
        if(activeCompId) refreshResultsView();
    }

    // --- KLASYFIKACJE I ZARZƒÑDZANIE ---
    function getRanks(res) {
        res.sort((a,b) => (parseFloat(b.total)||0) - (parseFloat(a.total)||0));
        let lastS = -1, lastR = 0;
        return res.map((r, i) => { let s = parseFloat(r.total) || 0; if (s !== lastS) { lastR = i + 1; lastS = s; } return { ...r, rank: lastR }; });
    }

   async function getCalculatedStanding(gid) {
        const gSt = (await db.ref('global_klasyfikacje/'+gid).once('value')).val(), allR = (await db.ref('wyniki').once('value')).val()||{}, allC = (await db.ref(`kalendarze/${activeSeasonId}`).once('value')).val()||{}, scores = {};
        
        // 1. Zliczanie punkt√≥w (tak jak by≈Ço)
        Object.values(allC).forEach(c => {
            if(c.standings && c.standings[gid]) {
                getRanks(Object.values(allR[c.id] || {})).forEach(r => {
                    if(!scores[r.name]) scores[r.name] = { total: 0, w: 0, s: 0, t: 0 };
                    
                    if(r.rank === 1) scores[r.name].w++;
                    if(r.rank === 2) scores[r.name].s++;
                    if(r.rank === 3) scores[r.name].t++;

                    if(gSt?.type === 'fis') {
                        if(r.rank <= (c.qLimit||30)) scores[r.name].total += FIS_PTS[r.rank-1] || 0;
                    } else scores[r.name].total += (parseFloat(r.total)||0);
                });
            }
        });

        // 2. Sortowanie (od najwiƒôkszej liczby punkt√≥w)
        const sortedEntries = Object.entries(scores).sort((a,b) => b[1].total - a[1].total);

        // 3. Logika EGZEKWO (Ex aequo)
        let lastTotal = -999999; // Zmienna pomocnicza: wynik poprzednika
        let lastRank = 0;        // Zmienna pomocnicza: miejsce poprzednika

        return sortedEntries.map((s, i) => {
            const currentTotal = s[1].total;
            let rank;

            // Je≈õli wynik jest taki sam jak poprzednika -> to samo miejsce
            if (currentTotal === lastTotal) {
                rank = lastRank;
            } else {
                // Je≈õli inny -> miejsce wynika z kolejno≈õci w tabeli (i + 1)
                // Dziƒôki temu robi siƒô "przerwa" (np. 1, 1, 3)
                rank = i + 1;
            }

            // Zapamiƒôtaj dla nastƒôpnego skoczka w pƒôtli
            lastTotal = currentTotal;
            lastRank = rank;

            return {
                name: s[0], 
                total: currentTotal, 
                w: s[1].w, 
                s: s[1].s, 
                t: s[1].t, 
                pos: rank // Tutaj wstawiamy obliczone miejsce
            };
        });
    
        
        // Zwracamy obiekt, kt√≥ry MA w sobie w, s, t - dziƒôki temu zniknie 'undefined'
        return Object.entries(scores).sort((a,b) => b[1].total - a[1].total).map((s,i) => ({
            name: s[0], 
            total: s[1].total, 
            w: s[1].w, 
            s: s[1].s, 
            t: s[1].t, 
            pos: i+1
        }));
    }

    async function viewStanding(gid, name) {
        currentStandingId = gid;
        showPage('page-standings-view'); 
        document.getElementById('st-view-title').innerText = name;
        
        // Pobieramy dane z nowej funkcji powy≈ºej
        const sorted = await getCalculatedStanding(gid), gSt = (await db.ref('global_klasyfikacje/'+gid).once('value')).val();
        
        const isFinished = (await db.ref(`sezony/${activeSeasonId}/finished_standings/${gid}`).once('value')).val();
        document.getElementById('st-status-info').classList.toggle('hidden', !isFinished);
        
        // Nag≈Ç√≥wek tabeli z kolorami
        document.getElementById('st-view-head').innerHTML = `<th>Poz.</th><th>Zawodnik</th><th style="width:30px; color:gold; text-align:center;">I</th><th style="width:30px; color:silver; text-align:center;">II</th><th style="width:30px; color:#cd7f32; text-align:center;">III</th><th>Wynik</th>`;
        
        const b = document.getElementById('st-view-body'); b.innerHTML = '';
        sorted.forEach(s => { 
            // Teraz s.w, s.s i s.t majƒÖ warto≈õci (np. 0, 1, 2) zamiast undefined
            b.innerHTML += `<tr><td>${s.pos}</td><td>${s.name}</td><td style="text-align:center;">${s.w}</td><td style="text-align:center;">${s.s}</td><td style="text-align:center;">${s.t}</td><td><b>${s.total.toFixed(gSt?.type==='notes'?1:0)}</b></td></tr>`; 
        });
    }
   async function finalizeStanding() {
        if(!isAdmin) return;
        if(!confirm("Czy na pewno chcesz zako≈Ñczyƒá ten ranking? Wyniki zostanƒÖ trwale zapisane w profilach zawodnik√≥w.")) return;
        
        const gSt = (await db.ref('global_klasyfikacje/'+currentStandingId).once('value')).val();
        const seasonName = document.getElementById('tiles-title').innerText;
        
        // Pobieramy przeliczony ranking (ten sam co w tabeli, z ex aequo)
        const sorted = await getCalculatedStanding(currentStandingId);
        
        let count = 0;
        for (let s of sorted) {
            const jumper = globalSkoczkowie.find(j => j.name === s.name);
            if(jumper) {
                const record = {
                    seasonName: seasonName,
                    standingName: gSt.name,
                    rank: s.pos, // <-- KLUCZOWE: U≈ºywamy s.pos (obliczone ex aequo), a nie indeksu pƒôtli
                    score: s.total.toFixed(gSt.type==='notes'?1:0)
                };
                
                // Zapisujemy do profilu
                await db.ref(`skoczkowie/${jumper.id}/historia_rankingow`).push(record);
                count++;
            }
        }
        
        // Oznaczamy jako zako≈Ñczony
        await db.ref(`sezony/${activeSeasonId}/finished_standings/${currentStandingId}`).set(true);
        
        alert(`Ranking zako≈Ñczony! Zapisano wyniki dla ${count} zawodnik√≥w.`);
        viewStanding(currentStandingId, gSt.name);
    }

    async function resumeStanding() {
        if(!isAdmin) return;
        if(!confirm("UWAGA: Wznowienie usunie przyznane wyniki tego rankingu z profili skoczk√≥w. Czy chcesz kontynuowaƒá?")) return;
        
        const seasonName = document.getElementById('tiles-title').innerText;
        const gSt = (await db.ref('global_klasyfikacje/'+currentStandingId).once('value')).val();
        const standingName = gSt.name;

        const allJumpersSnap = await db.ref('skoczkowie').once('value');
        const allJumpers = allJumpersSnap.val() || {};
        const updates = {};

        let deletedCount = 0;
        for (const [jumperId, jumperData] of Object.entries(allJumpers)) {
            if (jumperData.historia_rankingow) {
                for (const [recId, record] of Object.entries(jumperData.historia_rankingow)) {
                    if (record.seasonName === seasonName && record.standingName === standingName) {
                        updates[`skoczkowie/${jumperId}/historia_rankingow/${recId}`] = null;
                        deletedCount++;
                    }
                }
            }
        }

        updates[`sezony/${activeSeasonId}/finished_standings/${currentStandingId}`] = null;
        await db.ref().update(updates);
        alert(`Ranking wznowiony. Usuniƒôto ${deletedCount} wpis√≥w z profili.`);
        viewStanding(currentStandingId, standingName);
    }

    // --- PROFIL (ZLICZANIE TYLKO Z≈ÅOTA DLA IO, M≈ö, M≈öL) ---
    async function openProfile(name) {
        showPage('page-profile'); document.getElementById('prof-name').innerText = name;
        
        // Zmieniamy strukturƒô 's' - dodajemy liczniki z≈Çota dla ka≈ºdej imprezy
        let hist = [], s = { 
            wins:[], pods:[], hillDom:{},
            io_all:[], io_gold: 0, 
            ms_all:[], ms_gold: 0, 
            msl_all:[], msl_gold: 0 
        };
        
        const allR = (await db.ref('wyniki').once('value')).val()||{}, allC = (await db.ref('kalendarze').once('value')).val()||{};
        
        const jumperObj = globalSkoczkowie.find(j => j.name === name);
        const finalStandingsDiv = document.getElementById('prof-final-records-global');
        finalStandingsDiv.innerHTML = '≈Åadowanie...';
        
        if(jumperObj) {
            db.ref(`skoczkowie/${jumperObj.id}/historia_rankingow`).once('value', sn => {
                const h = sn.val();
                if(!h) { finalStandingsDiv.innerHTML = 'Brak wpis√≥w archiwalnych.'; return; }
                let html = '<table><thead><tr><th>Sezon</th><th>Ranking</th><th>Miejsce</th><th>PKT/Nota</th></tr></thead><tbody>';
                Object.values(h).sort((a,b)=>b.seasonName.localeCompare(a.seasonName)).forEach(rec => {
                    let color = rec.rank == 1 ? '#ffd700' : (rec.rank == 2 ? '#c0c0c0' : (rec.rank == 3 ? '#cd7f32' : 'inherit'));
                    let weight = rec.rank <= 3 ? 'bold' : 'normal';
                    html += `<tr style="color:${color}; font-weight:${weight}"><td>${rec.seasonName}</td><td>${rec.standingName}</td><td>${rec.rank}</td><td>${rec.score}</td></tr>`;
                });
                html += '</tbody></table>';
                finalStandingsDiv.innerHTML = html;
            });
        } else {
            finalStandingsDiv.innerHTML = 'Brak powiƒÖzanego konta.';
        }

        for(let sid in allC) {
            for(let cid in allC[sid]) {
                const comp = allC[sid][cid], ranked = getRanks(Object.values(allR[cid]||{}));
                ranked.forEach(r => { if(r.name === name) {
                    const e = `${comp.date}: <b>${r.rank}.</b> (${comp.loc})`;
                    hist.push({d: comp.date, l: comp.loc, r: r.rank});
                    
                    if(comp.type === 'konkurs') { 
                        if(r.rank===1) { s.wins.push(e); s.hillDom[comp.loc] = (s.hillDom[comp.loc]||0)+1; } 
                        if(r.rank<=3) s.pods.push(e); 
                    }
                    
                    // --- IGRZYSKA (IO) ---
                    if(comp.type==='io') {
                        s.io_all.push(e); // Lista wszystkich
                        if(r.rank === 1) s.io_gold++; // Licznik z≈Çota
                    } 
                    
                    // --- MISTRZOSTWA ≈öWIATA (M≈ö) ---
                    if(comp.type==='ms') {
                        s.ms_all.push(e); // Lista wszystkich
                        if(r.rank === 1) s.ms_gold++; // Licznik z≈Çota
                    }
                    
                    // --- M≈ö W LOTACH (M≈öL) ---
                    if(comp.type==='msl') {
                        s.msl_all.push(e); // Lista wszystkich
                        if(r.rank === 1) s.msl_gold++; // Licznik z≈Çota
                    }
                }});
            }
        }
        hist.sort((a,b)=>b.d.localeCompare(a.d));
        document.getElementById('prof-history-10').innerHTML = hist.slice(0,10).map(x=>`<tr><td>${x.d}</td><td>${x.l}</td><td><b>${x.r}</b></td></tr>`).join('');
        document.getElementById('prof-history-full').innerHTML = hist.slice(10).map(x=>`<tr><td>${x.d}</td><td>${x.l}</td><td><b>${x.r}</b></td></tr>`).join('');
        
        document.getElementById('c-wins').innerText = s.wins.length; document.getElementById('prof-wins').innerHTML = s.wins.join('<br>') || 'Brak';
        document.getElementById('c-pods').innerText = s.pods.length; document.getElementById('prof-pods').innerHTML = s.pods.join('<br>') || 'Brak';
        
        // --- AKTUALIZACJA LICZNIK√ìW I LIST ---
        document.getElementById('c-io').innerText = s.io_gold; 
        document.getElementById('prof-io-list').innerHTML = s.io_all.join('<br>') || 'Brak start√≥w';
        
        document.getElementById('ms-count').innerText = s.ms_gold; 
        document.getElementById('prof-ms-list').innerHTML = s.ms_all.join('<br>') || 'Brak start√≥w';

        document.getElementById('msl-count').innerText = s.msl_gold; 
        document.getElementById('prof-msl-list').innerHTML = s.msl_all.join('<br>') || 'Brak start√≥w';
        // -------------------------------------
        
        const chartDiv = document.getElementById('prof-hills-chart'); chartDiv.innerHTML = '';
        const sortedHills = Object.entries(s.hillDom).sort((a,b)=>b[1]-a[1]);
        if(sortedHills.length > 0) {
            sortedHills.forEach(([loc, count]) => { chartDiv.innerHTML += `<div>${loc} (Wygrane: ${count})<div class="stat-bar-container"><div class="stat-bar-fill" style="width:${Math.min((count/5)*100, 100)}%"></div></div></div>`; });
        } else { chartDiv.innerHTML = 'Brak zwyciƒôstw.'; }

        // Ta nowa wersja dzieli tekst po przecinkach, usuwa spacje i sprawdza czy imiƒô jest na li≈õcie
const myRecs = globalHills.filter(h => (h.recKoAuth || "").split(',').map(s=>s.trim()).includes(name));
        document.getElementById('prof-rec-list').innerHTML = myRecs.length > 0 
            ? myRecs.map(h => `<div>${h.name}: <b>${h.recKoDist}m</b></div>`).join('') 
            : 'Brak rekord√≥w skoczni.';
            
        db.ref('osiagniecia_specjalne').once('value', sr => { document.getElementById('prof-special-records').innerHTML = Object.values(sr.val()||{}).filter(x=>x.name===name).map(x=>`‚≠ê ${x.text}`).join('<br>') || 'Brak'; });
    }

    // --- SYSTEMOWE ---
    function addNewCompetitionDirectly() {
        if(!activeSeasonId) return alert("B≈ÇƒÖd: Otw√≥rz sezon!");
        const newRef = db.ref('kalendarze').child(activeSeasonId).push();
        newRef.set({ id: newRef.key, date: "2026-01-01", type: "konkurs", loc: "Wybierz...", qLimit: 30 });
    }

    function addHill() {
        const id = "h_" + Date.now(), hs = document.getElementById('h-hs-val').value;
        const name = document.getElementById('h-name-base').value + " HS " + hs;
        db.ref('skocznie/'+id).set({ id, name, hs, k: document.getElementById('h-k-val').value, recKoAuth: document.getElementById('h-rk-auth').value, recKoDist: document.getElementById('h-rk-dist').value, recRealAuth: document.getElementById('h-rr-auth').value, recRealDist: document.getElementById('h-rr-dist').value });
    }

    // STRICT RENDERING: HILLS
    function refreshHillList(data) {
        const b = document.getElementById('hill-list'); b.innerHTML = '';
        const isEdit = isAdmin ? 'contenteditable="true" class="editable-cell"' : '';
        data.forEach(h => {
            b.innerHTML += `<tr><td ${isEdit} onblur="if(isAdmin) db.ref('skocznie/${h.id}').update({name:this.innerText})">${h.name}</td>
                <td>HS: <span ${isEdit} onblur="if(isAdmin) db.ref('skocznie/${h.id}').update({hs:this.innerText})">${h.hs}</span> / K: <span ${isEdit} onblur="if(isAdmin) db.ref('skocznie/${h.id}').update({k:this.innerText})">${h.k}</span></td>
                <td><span ${isEdit} onblur="if(isAdmin) db.ref('skocznie/${h.id}').update({recKoAuth:this.innerText})">${h.recKoAuth}</span> (<span ${isEdit} onblur="if(isAdmin) db.ref('skocznie/${h.id}').update({recKoDist:this.innerText})">${h.recKoDist}</span>m)</td>
                <td><span ${isEdit} onblur="if(isAdmin) db.ref('skocznie/${h.id}').update({recRealAuth:this.innerText})">${h.recRealAuth}</span> (<span ${isEdit} onblur="if(isAdmin) db.ref('skocznie/${h.id}').update({recRealDist:this.innerText})">${h.recRealDist}</span>m)</td>
                <td class="${isAdmin?'':'hidden'}"><button class="btn btn-del" onclick="db.ref('skocznie/${h.id}').remove()">X</button></td></tr>`;
        });
        const listDiv = document.getElementById('suggestions-h-rk');
        if(listDiv) listDiv.innerHTML = globalSkoczkowie.map(sk => `<div class="suggestion-item" onclick="document.getElementById('h-rk-auth').value='${sk.name}'; this.parentElement.style.display='none'">${sk.name}</div>`).join('');
    }

    function addResultRow() {
        const key = db.ref('wyniki/'+activeCompId).push().key;
        db.ref('wyniki/'+activeCompId+'/'+key).set({id: key, name: "Wybierz...", s1: '-', s2: '-', s3: '-', s4: '-', total: 0});
    }

    // STRICT RENDERING: RESULTS
    function refreshResultsView() {
        db.ref('wyniki/'+activeCompId).on('value', s => {
            const data = Object.values(s.val()||{}).filter(x => x && x.id);
            const qL = parseInt(document.getElementById('q-limit-input').value)||30, ranked = getRanks([...data]);
            const b = document.getElementById('results-body'); b.innerHTML = '';
            document.querySelectorAll('.msl-extra').forEach(el=>activeType==='msl'?el.classList.remove('hidden'):el.classList.add('hidden'));
            document.querySelectorAll('.s2-col').forEach(el=>activeType==='kwali'?el.classList.add('hidden'):el.classList.remove('hidden'));
            ranked.forEach(r => {
                const isQ = (r.rank <= qL) ? '<span class="q-badge">[Q]</span>' : '';
                
                // SECURE INPUT RENDERING
                let nameCell = '';
                if (isAdmin) {
                    nameCell = `<div class="dropdown-wrapper"><input type="text" class="search-input" value="${r.name}" oninput="filterLocalList(this, 'list-${r.id}')" onfocus="document.getElementById('list-${r.id}').style.display='block'"><div id="list-${r.id}" class="suggestions-list">${globalSkoczkowie.map(sk => `<div class="suggestion-item" onclick="confirmJumper('${r.id}', '${sk.name}')">${sk.name}</div>`).join('')}</div></div>`;
                } else {
                    nameCell = `<b>${r.name}</b>`;
                }

                // SECURE SCORE RENDERING
                const editAttr = isAdmin ? 'contenteditable="true"' : '';
                
                let row = `<tr><td>${r.rank}${isQ}</td><td>${nameCell}</td><td ${editAttr} onfocus="adminCalcToBeat('${r.id}','s1',${parseFloat(ranked[0]?.total)||0})" onblur="calcRes('${r.id}','s1',this.innerText)">${r.s1}</td>`;
                if(activeType!=='kwali') row += `<td class="s2-col" ${editAttr} onfocus="adminCalcToBeat('${r.id}','s2',${parseFloat(ranked[0]?.total)||0})" onblur="calcRes('${r.id}','s2',this.innerText)">${r.s2}</td>`;
                if(activeType==='msl') row += `<td ${editAttr} onblur="calcRes('${r.id}','s3',this.innerText)">${r.s3}</td><td ${editAttr} onblur="calcRes('${r.id}','s4',this.innerText)">${r.s4}</td>`;
                
                b.innerHTML += row + `<td class="col-total">${(parseFloat(r.total)||0).toFixed(1)}</td><td class="admin-only ${isAdmin?'':'hidden'} col-action"><button class="btn btn-del" onclick="db.ref('wyniki/${activeCompId}/${r.id}').remove()">X</button></td></tr>`;
            });
        });
    }

    window.filterLocalList = function(i, lId) { const v = i.value.toUpperCase(); const l = document.getElementById(lId); l.style.display = 'block'; Array.from(l.children).forEach(d => { d.style.display = d.innerText.toUpperCase().includes(v) ? 'block' : 'none'; }); };
    window.confirmJumper = function(rId, n) { db.ref(`wyniki/${activeCompId}/${rId}`).update({name: n}); };
    window.confirmHill = function(cId, n) { db.ref(`kalendarze/${activeSeasonId}/${cId}`).update({loc: n}); };
    function showPage(p) { document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden')); document.getElementById(p).classList.remove('hidden'); if(p==='page-standings-selection') refreshStandingsSelection(); }
    function openSeason(id, n) { activeSeasonId = id; document.getElementById('tiles-title').innerText = n; showPage('page-season-tiles'); db.ref('kalendarze/'+id).on('value', s => renderCalendar(Object.values(s.val()||{}))); }
    function addSeason() { const n = prompt("Nazwa:"); if(n) db.ref('sezony/'+Date.now()).set({id:Date.now().toString(), name:n}); }
    function addSkoczek() { const n=prompt("Imiƒô:"); if(n) db.ref('skoczkowie/'+Date.now()).set({id: Date.now().toString(), name:n}); }
    function createGlobalStanding() { const n = document.getElementById('global-st-name').value, t = document.getElementById('global-st-type').value; if(n) db.ref('global_klasyfikacje').push({name:n, type:t}).then(()=>document.getElementById('global-st-name').value=''); }
    function addSpecialRecord() { const n=document.getElementById('rec-name-in').value, t=document.getElementById('rec-text-in').value; if(n && t) db.ref('osiagniecia_specjalne').push({name:n, text:t}).then(()=>document.getElementById('rec-text-in').value=''); }
    
    // SAVE FUNCTION (SECURE)
    function calcRes(rid, f, v) { 
        if(!isAdmin) return; // SECURITY CHECK
        let val = v.trim()==='-'?'-':parseFloat(v.replace(',','.'))||0; 
        db.ref(`wyniki/${activeCompId}/${rid}`).update({[f]:val}).then(()=>{ db.ref(`wyniki/${activeCompId}/${rid}`).once('value', s=>{ let d=s.val(), sum=0; ['s1','s2','s3','s4'].forEach(x=>{ if(d[x]!=='-' && d[x]!==undefined) sum+=parseFloat(d[x]||0); }); db.ref(`wyniki/${activeCompId}/${rid}`).update({total:sum}); }); }); 
    }

    // LIVE TO BEAT - ADMIN SENDS, EVERYONE SEES
    function adminCalcToBeat(rid, ser, leader) { 
        if(!isAdmin) return; 
        db.ref(`wyniki/${activeCompId}/${rid}`).once('value', s => { 
            const d = s.val(); if(!d) return; 
            let p = (ser==='s2'?parseFloat(d.s1||0):0); 
            const needed = (leader-p).toFixed(1);
            db.ref('status/liveToBeat').set(`Aby prowadziƒá: ${needed} m (Zawodnik: ${d.name})`);
        }); 
    }
    
    function updateQLimit(v) { db.ref(`kalendarze/${activeSeasonId}/${activeCompId}/qLimit`).set(parseInt(v)); }
    function toggleStatList(id) { const el = document.getElementById(id); el.style.display = (el.style.display==='block')?'none':'block'; }

    // STRICT RENDERING: CALENDAR
    function renderCalendar(data) { 
        const b = document.getElementById('calendar-body'); b.innerHTML = ''; 
        data.sort((a,b)=>a.date.localeCompare(b.date)).forEach(c => { 
            // Secure Loc Input
            let locCell = '';
            if(isAdmin) {
                locCell = `<div class="dropdown-wrapper"><input type="text" class="search-input" value="${c.loc}" oninput="filterLocalList(this, 'list-h-${c.id}')" onfocus="document.getElementById('list-h-${c.id}').style.display='block'"><div id="list-h-${c.id}" class="suggestions-list">${globalHills.map(h => `<div class="suggestion-item" onclick="confirmHill('${c.id}', '${h.name}')">${h.name}</div>`).join('')}</div></div>`;
            } else {
                locCell = c.loc;
            }

            b.innerHTML += `<tr><td contenteditable="${isAdmin}" onblur="if(isAdmin) db.ref('kalendarze/${activeSeasonId}/${c.id}').update({date:this.innerText})">${c.date}</td><td><select class="${isAdmin?'':'hidden'}" onchange="db.ref('kalendarze/${activeSeasonId}/${c.id}').update({type:this.value})"><option value="konkurs" ${c.type==='konkurs'?'selected':''}>Konkurs</option><option value="kwali" ${c.type==='kwali'?'selected':''}>Kwalifikacje</option><option value="ms" ${c.type==='ms'?'selected':''}>M≈ö</option><option value="io" ${c.type==='io'?'selected':''}>IO</option><option value="msl" ${c.type==='msl'?'selected':''}>M≈öL</option></select><span class="${isAdmin?'hidden':''}">${c.type.toUpperCase()}</span></td><td>${locCell}</td><td><button class="btn" style="background:var(--primary); color:white;" onclick="openResults('${c.id}','${c.loc}','${c.type}')">Wyniki</button> ${isAdmin?`<button class="btn btn-del" onclick="db.ref('kalendarze/${activeSeasonId}/${c.id}').remove()">X</button>`:''}</td></tr>`; 
        }); 
    }

    // RECORDS RENDERING (WITH DELETE BTN)
    db.ref('osiagniecia_specjalne').on('value', s => refreshRecordsList(s.val()));

    function refreshRecordsList(data) {
        const d = document.getElementById('global-records-list');
        d.innerHTML = '';
        if(!data) return;
        
        Object.entries(data).forEach(([key, r]) => {
            const delBtn = isAdmin ? `<button class="btn btn-del" style="margin-left:auto" onclick="db.ref('osiagniecia_specjalne/${key}').remove()">X</button>` : '';
            d.innerHTML += `<div class="card" style="padding:10px; display:flex; align-items:center;">
                <span>‚≠ê <b>${r.name}</b>: ${r.text}</span>
                ${delBtn}
            </div>`;
        });
    }

    db.ref('sezony').on('value', s => { const list = document.getElementById('seasons-list'); list.innerHTML = ''; Object.values(s.val()||{}).forEach(sez => list.innerHTML += `<div class="card" style="display:flex; justify-content:space-between; align-items:center;"><b>${sez.name}</b><div><button class="btn" onclick="openSeason('${sez.id}','${sez.name}')">Otw√≥rz</button> <button class="btn btn-del admin-only ${isAdmin?'':'hidden'}" onclick="db.ref('sezony/${sez.id}').remove()">X</button></div></div>`); });
    db.ref('skoczkowie').on('value', s => { globalSkoczkowie=Object.values(s.val()||{}); const b=document.getElementById('skoczkowie-list'); if(b) { b.innerHTML=''; globalSkoczkowie.forEach(sk=>b.innerHTML+=`<tr><td>${sk.name}</td><td><button class="btn" onclick="openProfile('${sk.name}')">Profil</button></td><td class="admin-only ${isAdmin?'':'hidden'}"><button class="btn-del" onclick="db.ref('skoczkowie/${sk.id}').remove()">X</button></td></tr>`); } });
    db.ref('skocznie').on('value', s => { globalHills = Object.values(s.val()||{}); refreshHillList(globalHills); });
    
    db.ref('global_klasyfikacje').on('value', s => { const adminL = document.getElementById('global-standings-admin-list'); if(adminL) { adminL.innerHTML = ''; Object.entries(s.val()||{}).forEach(([id, st]) => adminL.innerHTML += `<div class="card" style="padding:10px;"><b>${st.name}</b> <button class="btn-del" onclick="db.ref('global_klasyfikacje/${id}').remove()">X</button></div>`); } });
    async function openResults(id, loc, type) { activeCompId = id; activeType = type; document.getElementById('current-comp-title').innerText = loc; showPage('page-results'); refreshResultsView(); const gL = (await db.ref('global_klasyfikacje').once('value')).val() || {}, compD = (await db.ref(`kalendarze/${activeSeasonId}/${id}`).once('value')).val() || {}, checkB = document.getElementById('global-checkboxes'); checkB.innerHTML = ''; Object.entries(gL).forEach(([gid, st]) => { const isC = compD.standings && compD.standings[gid] ? 'checked' : ''; checkB.innerHTML += `<label style="margin-left:10px;"><input type="checkbox" ${isC} onchange="db.ref('kalendarze/${activeSeasonId}/${activeCompId}/standings/${gid}').set(this.checked?true:null)"> ${st.name}</label>`; }); }
    async function refreshStandingsSelection() { const gL = (await db.ref('global_klasyfikacje').once('value')).val() || {}, list = document.getElementById('standings-user-list'); if(!list) return; list.innerHTML = ''; Object.entries(gL).forEach(([gid, st]) => { list.innerHTML += `<div class="card" style="display:flex; justify-content:space-between; align-items:center;"><b>${st.name}</b><button class="btn" style="background:var(--primary); color:white;" onclick="viewStanding('${gid}','${st.name}')">Ranking</button></div>`; }); }

    document.addEventListener('click', e => { if(!e.target.classList.contains('search-input')) document.querySelectorAll('.suggestions-list').forEach(d => d.style.display = 'none'); });
</script>
</script>
</body>
</html>

