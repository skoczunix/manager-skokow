
<!DOCTYPE html>
<html lang="pl">
<head>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <title>Pro Manager Skok√≥w - ULTIMATE SECURE V22 (Live Sync & Records Fix)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
/* --- FIX PE≈ÅNEGO EKRANU DLA IO (USUWANIE BIA≈ÅEJ RAMKI) --- */

/* Gdy body ma klasƒô 'io-active', usuwamy bia≈Çe t≈Ço g≈Ç√≥wnego kontenera */
body.io-active .container {
    background: transparent !important;
    box-shadow: none !important;
    border: none !important;
    max-width: 100% !important; /* Rozszerzamy na ca≈Çy ekran */
    padding: 10px !important;
}

/* Ale sam ≈õrodek z wynikami niech trzyma fason (≈ºeby siƒô nie rozjecha≈Ç za szeroko) */
body.io-active #page-results {
    max-width: 1400px;
    margin: 0 auto;
}

/* Dodatkowo nag≈Ç√≥wek "Skoki Narciarskie Kogama" w trybie IO mo≈ºe byƒá ukryty lub zmieniony */
body.io-active header {
    display: none; /* Ukrywamy g≈Ç√≥wny nag≈Ç√≥wek, bo mamy ten ≈Çadny z belki */
}

body.io-active nav {
    background: rgba(0,0,0,0.5); /* Ciemniejsza nawigacja */
    border-bottom: 1px solid #00ffff;
}
/* --- FIX WPISYWANIA WYNIK√ìW (TABLE CELL EDIT) W IO --- */

/* 1. WyglƒÖd pola, gdy w nie klikniesz (FOCUS) */
.theme-io td[contenteditable="true"]:focus {
    /* Zmieniamy to jasne t≈Ço na ciemne */
    background: #001529 !important; 
    
    /* Tekst na neonowy b≈Çƒôkit, ≈ºeby by≈Ço widaƒá co piszesz */
    color: #00ffff !important; 
    
    /* Neonowa ramka zamiast tej ≈º√≥≈Çtej */
    outline: 2px solid #00ffff !important; 
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.4); /* Po≈õwiata */
}

/* 2. WyglƒÖd pola edytowalnego, gdy nie jest aktywne */
.theme-io td[contenteditable="true"] {
    background: rgba(255, 255, 255, 0.05) !important;
    border: 1px dashed rgba(0, 255, 255, 0.2) !important; /* Delikatna ramka pomocnicza */
    color: white !important;
}
/* --- FIX PANELU ADMINA (INPUTY I CHECKBOXY) W TRYBIE IO --- */

/* 1. Zmieniamy ten ≈º√≥≈Çty panel na ciemne szk≈Ço */
.theme-io .admin-only.card {
    background: rgba(0, 15, 30, 0.85) !important; /* Ciemne t≈Ço */
    border: 1px solid rgba(0, 255, 255, 0.3) !important; /* Delikatna cyjanowa ramka */
    color: #ffffff !important; /* Bia≈Çy tekst */
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6); /* Cie≈Ñ pod panelem */
}

/* 2. Tekst przy checkboxach (Puchar ≈öwiata itp.) */
.theme-io .admin-only label {
    color: #b3e5fc !important; /* Jasnoniebieski odcie≈Ñ bieli */
    font-weight: 500;
    text-shadow: 0 1px 2px rgba(0,0,0,0.8); /* Cie≈Ñ pod tekstem dla czytelno≈õci */
    cursor: pointer;
}
.theme-io .admin-only label:hover {
    color: #00ffff !important; /* Po najechaniu ≈õwieci na cyjan */
}

/* 3. WyglƒÖd checkbox√≥w (to ma≈Çe okienko do zaznaczania) */
.theme-io input[type="checkbox"] {
    accent-color: #00ffff; /* Nowoczesne CSS: zmienia kolor "ptaszka" na neonowy */
    cursor: pointer;
    transform: scale(1.1); /* Lekko powiƒôkszone */
}

/* 4. Pola wpisywania (Inputy) - np. Limit Q, Nazwiska */
.theme-io input, 
.theme-io select,
.theme-io .search-input {
    background: rgba(255, 255, 255, 0.1) !important; /* P√≥≈Çprzezroczyste t≈Ço */
    border: 1px solid #007bb5 !important; /* Niebieska ramka */
    color: #ffffff !important; /* Bia≈Çy tekst w ≈õrodku */
    border-radius: 4px;
}

/* Efekt po klikniƒôciu w pole */
.theme-io input:focus,
.theme-io select:focus {
    background: rgba(0, 20, 40, 0.9) !important;
    border-color: #00ffff !important;
    outline: none;
    box-shadow: 0 0 8px rgba(0, 255, 255, 0.5);
}

/* 5. Przycisk USUWANIA (X) - robimy go w stylu "Alert" */
.theme-io .btn-del {
    background: rgba(255, 0, 0, 0.15) !important; /* Przezroczysta czerwie≈Ñ */
    border: 1px solid #ff3333 !important;
    color: #ff3333 !important;
    font-weight: bold;
    transition: all 0.2s ease;
    text-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
}

.theme-io .btn-del:hover {
    background: #ff0000 !important; /* Pe≈Çna czerwie≈Ñ po najechaniu */
    color: white !important;
    box-shadow: 0 0 10px #ff0000;
    cursor: pointer;
}
/* --- FIX PASKA STATUSU DLA TRYBU IO --- */
.theme-io .live-info {
    /* Ciemne, szklane t≈Ço zamiast ≈º√≥≈Çtego */
    background: linear-gradient(90deg, rgba(0, 20, 40, 0.8) 0%, rgba(0, 100, 200, 0.6) 100%) !important;
    
    /* Bia≈Çy tekst z lekkƒÖ po≈õwiatƒÖ */
    color: white !important;
    text-shadow: 0 0 8px rgba(0, 255, 255, 0.8);
    
    /* Neonowy pasek z lewej strony zamiast ≈º√≥≈Çtego */
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-left: 6px solid #00ffff !important;
    
    /* Odsuniƒôcie i cie≈Ñ, ≈ºeby "wisia≈Ç" nad tabelƒÖ */
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
    margin-bottom: 20px;
    letter-spacing: 1px;
    text-transform: uppercase;
    font-size: 1.1rem;
}
/* --- STYL IGRZYSKA (IO) --- */
.theme-io {
    background: radial-gradient(circle at center, #005f9e 0%, #001a33 100%) !important;
    color: white !important;
    font-family: 'Roboto', sans-serif; /* Opcjonalnie inna czcionka */
}

/* Belka tytu≈Çowa a'la TV */
.theme-io #current-comp-title {
    background: linear-gradient(90deg, #00c6ff 0%, #0072ff 100%);
    color: white;
    padding: 15px;
    border-radius: 0 20px 0 20px;
    box-shadow: 0 0 15px rgba(0, 198, 255, 0.5);
    text-transform: uppercase;
    letter-spacing: 1px;
    text-align: left;
    border-bottom: 2px solid rgba(255,255,255,0.5);
    margin-bottom: 5px;
}

/* Tabela w stylu IO */
.theme-io table {
    border-collapse: separate;
    border-spacing: 0 4px; /* Przerwy miƒôdzy wierszami */
}

.theme-io th {
    background: rgba(0, 198, 255, 0.2);
    border: 1px solid rgba(0, 198, 255, 0.4);
    color: #00ffff;
    text-transform: uppercase;
    font-size: 0.8rem;
}

.theme-io td {
    background: linear-gradient(90deg, rgba(0, 50, 100, 0.6) 0%, rgba(0, 30, 60, 0.8) 100%);
    border: none;
    border-left: 4px solid transparent;
    color: white;
    font-weight: bold;
}

/* Lider ma jasny pasek z lewej */
.theme-io tr:nth-child(1) td {
    border-left: 4px solid #00ffff;
    background: linear-gradient(90deg, rgba(0, 198, 255, 0.3) 0%, rgba(0, 30, 60, 0.8) 100%);
}

.theme-io .btn { border: 1px solid white; }
.theme-io input { background: rgba(255,255,255,0.9); }
/* --- FIXED V2 STYLE (FINAL + BUTTON FIX) --- */

:root { 
    --primary: #003366; 
    --glass: rgba(255, 255, 255, 0.95);
    --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

/* 1. T≈ÅO - CZYSTY GRADIENT */
body { 
    font-family: 'Montserrat', sans-serif; 
    margin: 0; 
    color: #1a1a1a;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%) !important; 
    min-height: 100vh;
}

/* --- 2. NAPRAWA PASKA ADMINA I PRZYCISKU ZALOGUJ --- */
.admin-bar {
    background: #000000 !important; /* Czysta czer≈Ñ dla kontrastu */
    color: white !important;
    padding: 10px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid #003366;
    font-size: 0.9rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
}

/* Przycisk logowania - teraz musi byƒá widoczny! */
#auth-btn {
    background: #ff416c !important; /* Jaskrawy r√≥≈º/czerwie≈Ñ */
    color: white !important;
    border: 2px solid white !important;
    padding: 5px 15px;
    border-radius: 20px; /* ZaokrƒÖglony */
    font-weight: bold;
    text-transform: uppercase;
    cursor: pointer;
    box-shadow: 0 0 10px rgba(255, 65, 108, 0.6); /* ≈öwiecƒÖca po≈õwiata */
    transition: transform 0.2s;
}
#auth-btn:hover {
    transform: scale(1.05);
    background: #ff1b4d !important;
}

/* Status po≈ÇƒÖczenia - jasna ziele≈Ñ */
#status {
    color: #00ff00 !important;
    font-weight: bold;
    text-shadow: 0 0 5px #00ff00;
}


/* 3. NAG≈Å√ìWEK */
header {
    background: linear-gradient(to bottom, #003366, #001a33) !important;
    padding: 30px;
    margin-bottom: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
header h1 {
    color: #ffffff !important;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    text-transform: uppercase;
    font-weight: 800;
    margin: 0;
    font-style: italic;
    letter-spacing: 1px;
}

/* --- KARTY I SZK≈ÅO --- */
.container { 
    max-width: 1200px; 
    margin: 0 auto 40px auto; 
    padding: 10px; 
    background: transparent !important; 
    box-shadow: none !important;
}

.card, table, .event-card, .login-box, #global-standings-admin-list { 
    background: #ffffff !important; 
    border-radius: 12px !important; 
    border: 1px solid #dcdcdc;
    box-shadow: var(--shadow);
    color: #003366 !important;
    margin-bottom: 20px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

/* Animacja najechania */
.event-card:hover, .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
    border-color: #003366;
    cursor: pointer;
}

/* --- TABELE --- */
th { 
    background: #003366 !important; 
    color: white !important; 
    padding: 12px;
    text-transform: uppercase;
    font-size: 0.85rem;
}
td {
    border-bottom: 1px solid #eee !important;
    padding: 10px;
    color: #333 !important;
}

/* --- WYJƒÑTEK: KOLORY TYLKO W PROFILU (HISTORIA) --- */
/* Z≈Çoto (#ffd700) */
tr[style*="#ffd700"] td {
    background: linear-gradient(90deg, #fff9c4 0%, #ffffff 100%) !important;
    border-left: 5px solid #ffd700 !important;
    color: #000 !important; font-weight: bold;
}
/* Srebro (#c0c0c0) */
tr[style*="#c0c0c0"] td {
    background: linear-gradient(90deg, #f0f0f0 0%, #ffffff 100%) !important;
    border-left: 5px solid #a0a0a0 !important;
    color: #000 !important; font-weight: bold;
}
/* BrƒÖz (#cd7f32) */
tr[style*="#cd7f32"] td {
    background: linear-gradient(90deg, #ffe0b2 0%, #ffffff 100%) !important;
    border-left: 5px solid #cd7f32 !important;
    color: #000 !important; font-weight: bold;
}


/* --- KARTA REKORDU ≈ªYCIOWEGO (PB) --- */
#pb-card-dynamic {
    background: #ffffff !important;
    border: 2px solid #003366 !important;
    color: #003366 !important;
}
#pb-card-dynamic h3 { opacity: 0.7; color: #003366 !important; text-shadow: none !important; }
#pb-card-dynamic div { color: #003366 !important; text-shadow: none !important; }


/* --- INPUTY I PRZYCISKI --- */
input, select, .search-input {
    background: #fff !important;
    border: 1px solid #999 !important;
    color: #000 !important;
    padding: 8px;
    border-radius: 4px;
}
.btn-add { 
    background: #003366 !important; 
    color: white !important; 
    border: none !important;
    padding: 10px 20px;
    text-transform: uppercase;
    font-weight: bold;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.btn-del {
    background: #d32f2f !important;
    color: white !important;
    border: none;
}

/* ========================================= */
/* === TRYB IO (IGRZYSKA) - BEZ ZMIAN === */
/* ========================================= */
body.io-active {
    background: #001a33 !important;
}
body.io-active .container {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
}
body.io-active header { display: none !important; }

/* Styl IO */
.theme-io {
    background: radial-gradient(circle at center, #005f9e 0%, #001a33 100%) !important;
    color: white !important;
    font-family: 'Roboto', sans-serif;
}
.theme-io table { border-collapse: separate; border-spacing: 0 4px; background: transparent !important; border: none !important; }
.theme-io th { background: rgba(0, 198, 255, 0.2) !important; border: 1px solid #00ffff !important; color: #00ffff !important; }
.theme-io td {
    background: linear-gradient(90deg, rgba(0, 50, 100, 0.8) 0%, rgba(0, 30, 60, 0.9) 100%) !important;
    color: white !important;
    border: none !important;
    border-left: 4px solid transparent !important;
}
.theme-io tr:nth-child(1) td {
    border-left: 4px solid #00ffff !important;
    background: linear-gradient(90deg, rgba(0, 198, 255, 0.4) 0%, rgba(0, 30, 60, 0.9) 100%) !important;
}
.theme-io input, .theme-io select {
    background: rgba(0, 20, 40, 0.5) !important;
    border: 1px solid #00ffff !important;
    color: white !important;
}
.theme-io .btn-add {
    background: linear-gradient(90deg, #00c6ff 0%, #0072ff 100%) !important;
    border: 1px solid #00ffff !important;
    box-shadow: 0 0 15px #00ffff !important;
}
.theme-io .live-info {
    background: linear-gradient(90deg, rgba(0, 20, 40, 0.9) 0%, rgba(0, 100, 200, 0.6) 100%) !important;
    color: white !important;
    text-shadow: 0 0 8px rgba(0, 255, 255, 0.8);
    border-left: 6px solid #00ffff !important;
}
        nav { background: var(--primary); padding: 12px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        nav button { background: transparent; border: 1px solid rgba(255,255,255,0.5); color: white; padding: 8px 15px; cursor: pointer; border-radius: 6px; font-weight: bold; }
        header { background: linear-gradient(to bottom, var(--primary), #001a33); color: white; padding: 30px; text-align: center; }
        .container { max-width: 1200px; margin: 25px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: center; vertical-align: middle; word-wrap: break-word; font-size: 0.9rem; }
        th { background: var(--primary); color: white; }
        
        /* Styl zaznaczania dla admina */
        td[contenteditable="true"]:focus { outline: 2px solid var(--gold); background: #fffdf0; }
        
        .col-rank { width: 55px; }
        .col-name { width: auto; }
        .col-score { width: 75px; }
        .col-total { width: 90px; font-weight: bold; }
        .col-action { width: 55px; }

        .hidden { display: none !important; }
        .btn { padding: 8px 15px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; }
        .btn-add { background: var(--live); color: white; margin-bottom: 20px; }
        .btn-del { background: var(--accent); color: white; padding: 5px 10px; font-size: 0.8rem; border-radius: 4px; }
        .btn-action { background: #ff9800; color: white; margin-left: 10px; }
        
        .card { background: #f8f9fa; border: 1px solid #ddd; border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .live-info { background: #fff3cd; border-left: 5px solid #ffc107; padding: 15px; margin-bottom: 15px; font-weight: bold; text-align: center; border-radius: 8px; font-size: 1.2rem; }
        .q-badge { color: #00ff00; font-weight: bold; margin-left: 5px; font-size: 0.85rem; background: rgba(0,255,0,0.1); padding: 2px 5px; border-radius: 4px; border: 1px solid #00ff00; }
        .editable-cell { background: #fff9e6; border: 1px dashed #ffc107 !important; outline: none; }

        .dropdown-wrapper { position: relative; width: 100%; }
        .search-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.9rem; }
        .suggestions-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; z-index: 9999; max-height: 200px; overflow-y: auto; display: none; text-align: left; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .suggestion-item:hover { background: #f0f0f0; }

        .event-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .event-card { background: #fff; border: 1px solid #ddd; border-radius: 12px; padding: 15px; text-align: center; border-top: 5px solid #ccc; cursor: pointer; transition: transform 0.2s; }
        .event-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .stat-details { font-size: 0.8rem; text-align: left; background: #fff; border: 1px solid #eee; padding: 8px; margin-top: 8px; border-radius: 6px; display: none; max-height: 150px; overflow-y: auto; }
        .stat-bar-container { background: #eee; border-radius: 4px; height: 12px; width: 100%; margin-top: 5px; overflow: hidden; }
        .stat-bar-fill { background: var(--primary); height: 100%; }

        .login-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 10000; display:flex; justify-content:center; align-items:center; }
        .login-box { background: white; padding: 30px; border-radius: 10px; width: 300px; text-align: center; }
        .login-input { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="admin-bar">
    <div id="status">Status: üîµ ≈ÅƒÖczenie...</div>
    <div id="user-info" class="hidden" style="margin-right:15px; font-size:0.9rem; color:#aaa;">Zalogowany</div>
    <button id="auth-btn" class="btn" style="background: var(--accent); color:white;" onclick="handleAuthClick()">Admin (Logowanie)</button>
</div>

<nav>
    <button onclick="showPage('page-home')">üè† SEZONY</button>
    <button onclick="showPage('page-skoczkowie')">‚õ∑Ô∏è SKOCZKOWIE</button>
    <button onclick="showPage('page-skocznie')">üèîÔ∏è SKOCZNIE</button>
    <button onclick="showPage('page-records-main')">üéñÔ∏è REKORDY</button>
<button onclick="showPage('page-galeria')">üèÜ GALERIA S≈ÅAW</button>
</nav>

<header><h1>Skoki Narciarskie Kogama</h1></header>

<div id="login-modal" class="login-overlay hidden">
    <div class="login-box">
        <h2>Panel Admina</h2>
        <input type="email" id="login-email" class="login-input" placeholder="Email">
        <input type="password" id="login-pass" class="login-input" placeholder="Has≈Ço">
        <button class="btn" style="background:var(--primary); color:white; width:100%;" onclick="performLogin()">Zaloguj siƒô</button>
        <button class="btn" style="background:#ccc; color:#333; width:100%; margin-top:10px;" onclick="document.getElementById('login-modal').classList.add('hidden')">Anuluj</button>
    </div>
</div>

<div class="container">
    <div id="page-home">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <h2>Lista Sezon√≥w</h2>
                <button class="btn btn-add admin-only hidden" onclick="addSeason()">+ Nowy Sezon</button>
                <div id="seasons-list"></div>
            </div>
            <div class="admin-only hidden">
                <h2>Klasyfikacje Globalne</h2>
                <div id="global-standings-admin-list"></div>
                <div class="card">
                    <input type="text" id="global-st-name" class="search-input" placeholder="Nazwa Rankingu">
                    <select id="global-st-type" class="search-input" style="margin:5px 0;"><option value="fis">FIS (PunktujƒÖ tylko Q)</option><option value="notes">Suma Not (Wszyscy)</option></select>
                    <button class="btn btn-add" onclick="createGlobalStanding()">DODAJ RANKING</button>
                </div>
            </div>
        </div>
    </div>

    <div id="page-skocznie" class="hidden">
        <h2>Baza Skoczni</h2>
        <div class="admin-only hidden card">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input type="text" id="h-name-base" class="search-input" placeholder="Nazwa (np. Wis≈Ça)">
                <input type="number" id="h-hs-val" class="search-input" placeholder="HS">
                <input type="number" id="h-k-val" class="search-input" placeholder="K">
                <div class="dropdown-wrapper">
                    <input type="text" id="h-rk-auth" class="search-input" placeholder="Rekordzista KoGama" oninput="filterLocalList(this, 'suggestions-h-rk')">
                    <div id="suggestions-h-rk" class="suggestions-list"></div>
                </div>
                <input type="text" id="h-rk-dist" class="search-input" placeholder="Rekord KoGama (m)">
                <input type="text" id="h-rr-auth" class="search-input" placeholder="Real Kto">
                <input type="text" id="h-rr-dist" class="search-input" placeholder="Real Metry">
            </div>
            <button class="btn btn-add" style="margin-top:10px;" onclick="addHill()">+ Dodaj Skoczniƒô</button>
        </div>
        <table><thead><tr><th>Nazwa</th><th>Parametry</th><th>Rekord KoGama</th><th>Rekord Realny</th><th class="admin-only hidden">X</th></tr></thead><tbody id="hill-list"></tbody></table>
    </div>

    <div id="page-calendar" class="hidden">
        <button class="btn" onclick="showPage('page-season-tiles')">‚Üê Powr√≥t</button>
        <h2>Kalendarz Sezonu</h2>
        <button class="btn btn-add admin-only hidden" onclick="addNewCompetitionDirectly()">+ DODAJ KONKURS</button>
        <table><thead><tr><th>Data</th><th>Rodzaj</th><th>Skocznia</th><th>Akcja</th></tr></thead><tbody id="calendar-body"></tbody></table>
    </div>

    <div id="page-results" class="hidden">
        <button class="btn" style="background:#666; color:white;" onclick="showPage('page-calendar')">‚Üê Powr√≥t</button>
        <h2 id="current-comp-title">...</h2>
        <div id="live-to-beat" class="live-info">Oczekiwanie na decyzjƒô sƒôdzi√≥w...</div>
        <div class="admin-only hidden card" style="display:flex; gap:20px; align-items:center; background:#fff9e6; border:1px solid orange;">
            <div>Limit Q: <input type="number" id="q-limit-input" value="30" style="width:60px;" oninput="updateQLimit(this.value)"></div>
            <div id="global-checkboxes"></div>
        </div>
        <button id="add-result-btn" class="btn btn-add admin-only hidden" onclick="addResultRow()">+ Skoczek</button>
        <table><thead><tr><th class="col-rank">Poz.</th><th class="col-name">Zawodnik</th><th class="col-score">S1</th><th class="s2-col col-score">S2</th><th class="msl-extra hidden col-score">S3</th><th class="msl-extra hidden col-score">S4</th><th class="s3-col hidden col-score">S3</th>
<th class="s4-col hidden col-score">S4</th><th class="col-score">Strata</th><th class="col-total">Nota</th><th class="admin-only hidden col-action">X</th></tr></thead><tbody id="results-body"></tbody></table>
    </div>

    <div id="page-profile" class="hidden">
        <button class="btn" onclick="showPage('page-skoczkowie')">‚Üê Powr√≥t</button>
        <h1 id="prof-name">...</h1>
        <div class="event-grid">
            <div class="event-card" onclick="toggleStatList('prof-wins')"><h4>üåç Wygrane P≈ö</h4><div id="c-wins">0</div><div id="prof-wins" class="stat-details"></div></div>
            <div class="event-card" onclick="toggleStatList('prof-pods')"><h4>ü•à Podia</h4><div id="c-pods">0</div><div id="prof-pods" class="stat-details"></div></div>
            <div class="event-card" onclick="toggleStatList('prof-io-list')"><h4>ü•á IO</h4><div id="c-io">0</div><div id="prof-io-list" class="stat-details"></div></div>
            <div class="event-card" onclick="toggleStatList('prof-ms-list')"><h4>üèÜ M≈ö</h4><div id="ms-count">0</div><div id="prof-ms-list" class="stat-details"></div></div>
            <div class="event-card" onclick="toggleStatList('prof-msl-list')"><h4>‚úàÔ∏è M≈öL</h4><div id="msl-count">0</div><div id="prof-msl-list" class="stat-details"></div></div>
        </div>
        <div class="card" style="margin-top:20px;">
            <h3>üìÖ Historia Start√≥w</h3>
            <table><thead><tr><th>Data</th><th>Miejsce</th><th>Poz.</th></tr></thead><tbody id="prof-history-10"></tbody><tbody id="prof-history-full" class="hidden"></tbody></table>
            <button class="btn" style="width:100%; margin-top:10px;" onclick="document.getElementById('prof-history-full').classList.toggle('hidden'); this.innerText = (this.innerText === 'Poka≈º wiƒôcej' ? 'Poka≈º mniej' : 'Poka≈º wiƒôcej')">Poka≈º wiƒôcej</button>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px;">
            <div class="card"><h3>üìä Dominacja (Wygrane)</h3><div id="prof-hills-chart"></div></div>
            <div class="card"><h3>üéñÔ∏è Rekordy i Tytu≈Çy</h3><div id="prof-special-records"></div><h3>üèîÔ∏è Moje Rekordy Skoczni</h3><div id="prof-rec-list" style="font-size:0.8rem;"></div></div>
        </div>
        <h3>üèÜ Klasyfikacje Ko≈Ñcowe (Archiwum)</h3>
        <div class="card" id="prof-final-records-global">Brak wpis√≥w archiwalnych.</div>
    </div>

    <div id="page-records-main" class="hidden">
        <h2>Rekordy Historyczne</h2>
        <div class="admin-only hidden card">
            <div style="display:flex; gap:10px;">
                <input type="text" class="search-input" id="rec-name-in" placeholder="Kto" style="width: 150px; flex-shrink: 0;">
                <input type="text" class="search-input" id="rec-text-in" placeholder="Tre≈õƒá rekordu..." style="flex-grow: 1;">
                <button class="btn btn-add" onclick="addSpecialRecord()">DODAJ</button>
            </div>
        </div>
        <div id="global-records-list"></div>
    </div>
    <div id="page-galeria" class="hidden">
    <h2 style="text-align:center;">üèÜ Galeria S≈Çaw (All-Time)</h2>

    <div class="admin-only hidden card" style="background: #fff9e6; border: 1px solid #ffd700;">
        <h3>‚öôÔ∏è ZarzƒÖdzanie Tabelami Tytu≈Ç√≥w</h3>
        <div style="display:flex; gap:10px;">
            <select id="hof-select-standing" class="search-input"></select>
            <button class="btn btn-add" style="margin:0;" onclick="addHoFTable()">UTW√ìRZ TABELƒò</button>
        </div>
        <div id="hof-active-tables" style="margin-top:10px; font-size:0.9rem;">
            Aktywne: <span id="hof-tags"></span>
        </div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px;">
        <div class="card">
            <h3>ü•á Najwiƒôcej Zwyciƒôstw (P≈ö)</h3>
            <table id="table-hof-wins"><thead><tr><th>Poz.</th><th>Zawodnik</th><th>Suma</th></tr></thead><tbody id="body-hof-wins"></tbody></table>
            <button class="btn" style="width:100%; margin-top:5px;" onclick="toggleHofRows('body-hof-wins')">Poka≈º wiƒôcej</button>
        </div>
        <div class="card">
            <h3>ü•à Najwiƒôcej Podi√≥w (P≈ö)</h3>
            <table id="table-hof-pods"><thead><tr><th>Poz.</th><th>Zawodnik</th><th>Suma</th></tr></thead><tbody id="body-hof-pods"></tbody></table>
            <button class="btn" style="width:100%; margin-top:5px;" onclick="toggleHofRows('body-hof-pods')">Poka≈º wiƒôcej</button>
        </div>
    </div>

    <div class="event-grid" style="margin-top:20px;">
        <div class="card"><h4>ü•á Z≈Çota IO</h4><table id="table-hof-io"><thead><tr><th>Poz.</th><th>Zawodnik</th><th>Suma</th></tr></thead><tbody id="body-hof-io"></tbody></table></div>
        <div class="card"><h4>üèÜ Z≈Çota M≈ö</h4><table id="table-hof-ms"><thead><tr><th>Poz.</th><th>Zawodnik</th><th>Suma</th></tr></thead><tbody id="body-hof-ms"></tbody></table></div>
        <div class="card"><h4>‚úàÔ∏è Z≈Çota M≈öL</h4><table id="table-hof-msl"><thead><tr><th>Poz.</th><th>Zawodnik</th><th>Suma</th></tr></thead><tbody id="body-hof-msl"></tbody></table></div>
    </div>

    <h3 style="text-align:center; margin-top:30px;">üèÜ Klasyfikacje Ko≈Ñcowe (Tytu≈Çy)</h3>
    <div id="hof-dynamic-titles" style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;"></div>
<div class="card" style="margin-top: 30px; border: 1px solid #003366;">
        <h3 style="text-align:center;">üöÄ Najd≈Çu≈ºsze Loty (Rekordy ≈ªyciowe)</h3>
        <table id="table-hof-pb">
            <thead>
                <tr>
                    <th style="width:50px;">Poz.</th>
                    <th>Zawodnik</th>
                    <th style="width:100px;">Odleg≈Ço≈õƒá</th>
                </tr>
            </thead>
            <tbody id="body-hof-pb"></tbody>
        </table>
        <button class="btn" style="width:100%; margin-top:5px;" onclick="toggleHofRows('body-hof-pb')">Poka≈º wiƒôcej</button>
    </div>
</div>
    <div id="page-season-tiles" class="hidden"><button class="btn" onclick="showPage('page-home')">‚Üê Powr√≥t</button><h2 id="tiles-title">...</h2><div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;"><div class="card" onclick="showPage('page-calendar')"><h2>üìÖ Kalendarz</h2></div><div class="card" onclick="showPage('page-standings-selection')"><h2>üèÜ Klasyfikacje</h2></div></div></div>
    <div id="page-skoczkowie" class="hidden"><h2>Baza Skoczk√≥w</h2><button class="btn btn-add admin-only hidden" onclick="addSkoczek()">+ Dodaj</button><table><thead><tr><th>Imiƒô</th><th>Profil</th><th class="admin-only hidden">X</th></tr></thead><tbody id="skoczkowie-list"></tbody></table></div>
    <div id="page-standings-selection" class="hidden"><button class="btn" onclick="showPage('page-season-tiles')">‚Üê Powr√≥t</button><h2>Rankingi</h2><div id="standings-user-list"></div></div>
    <div id="page-standings-view" class="hidden">
        <button class="btn" onclick="showPage('page-standings-selection')">‚Üê Powr√≥t</button>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="st-view-title">Ranking</h2>
            <div class="admin-only hidden">
                <button class="btn btn-action" style="background:var(--accent);" onclick="finalizeStanding()">Zako≈Ñcz (Zapisz w profilach)</button>
                <button class="btn btn-action" style="background:var(--live);" onclick="resumeStanding()">Wzn√≥w (Usu≈Ñ z profili)</button>
            </div>
        </div>
        <div id="st-status-info" class="live-info hidden">Ten ranking zosta≈Ç zako≈Ñczony i zapisany.</div>
        <table><thead><tr id="st-view-head"></tr></thead><tbody id="st-view-body"></tbody></table>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAMUC3EoBk9e_2c9JDuctpLw9E5ift1--U",
        authDomain: "skoki-kogama.firebaseapp.com",
        databaseURL: "https://skoki-kogama-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "skoki-kogama",
        storageBucket: "skoki-kogama.firebasestorage.app",
        messagingSenderId: "140387723904",
        appId: "1:140387723904:web:911efb3631b2a8d1e4d465",
        measurementId: "G-ZDZNGNHPCY"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    
    let isAdmin = false, activeSeasonId = null, activeCompId = null, activeType = '';
    let globalSkoczkowie = [], globalHills = [];
    let currentStandingId = null; 

    const FIS_PTS = [100, 80, 60, 50, 45, 40, 36, 32, 29, 26, 24, 22, 20, 18, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1];
    
    // AUTHENTICATION LISTENER
    db.ref('.info/connected').on('value', s => { document.getElementById('status').innerHTML = s.val() ? "Status: üü¢ Po≈ÇƒÖczono" : "Status: üî¥ Roz≈ÇƒÖczono"; });
    
    // LIVE SYNC LISTENER (Wszyscy widzƒÖ co ustawi≈Ç admin)
    db.ref('status/liveToBeat').on('value', s => {
        const msg = s.val() || "Oczekiwanie na decyzjƒô sƒôdzi√≥w...";
        document.getElementById('live-to-beat').innerText = msg;
    });

    auth.onAuthStateChanged(user => {
        if (user) {
            isAdmin = true;
            document.getElementById('auth-btn').innerText = "Wyloguj";
            document.getElementById('auth-btn').style.background = "#555";
            document.getElementById('user-info').innerText = user.email;
            document.getElementById('user-info').classList.remove('hidden');
            document.getElementById('login-modal').classList.add('hidden');
        } else {
            isAdmin = false;
            document.getElementById('auth-btn').innerText = "Zaloguj (Admin)";
            document.getElementById('auth-btn').style.background = "var(--accent)";
            document.getElementById('user-info').classList.add('hidden');
        }
        updateAdminUI();
    });

    function handleAuthClick() {
        if (isAdmin) {
            auth.signOut().then(() => alert("Wylogowano.")).catch(e => alert(e.message));
        } else {
            document.getElementById('login-modal').classList.remove('hidden');
        }
    }

    function performLogin() {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;
        auth.signInWithEmailAndPassword(email, pass).catch(error => {
            alert("B≈ÇƒÖd logowania: " + error.message);
        });
    }

    function updateAdminUI() {
        document.querySelectorAll('.admin-only, .btn-add').forEach(el => el.classList.toggle('hidden', !isAdmin));
        if(activeSeasonId) db.ref('kalendarze/'+activeSeasonId).once('value', s => renderCalendar(Object.values(s.val()||{})));
        db.ref('skocznie').once('value', s => refreshHillList(Object.values(s.val()||{})));
        // Refresh records to show/hide delete buttons
        db.ref('osiagniecia_specjalne').once('value', s => refreshRecordsList(s.val()));
        if(activeCompId) refreshResultsView();
    }

    // --- KLASYFIKACJE I ZARZƒÑDZANIE ---
    function getRanks(res) {
        res.sort((a,b) => (parseFloat(b.total)||0) - (parseFloat(a.total)||0));
        let lastS = -1, lastR = 0;
        return res.map((r, i) => { let s = parseFloat(r.total) || 0; if (s !== lastS) { lastR = i + 1; lastS = s; } return { ...r, rank: lastR }; });
    }

   async function getCalculatedStanding(gid) {
        const gSt = (await db.ref('global_klasyfikacje/'+gid).once('value')).val(), allR = (await db.ref('wyniki').once('value')).val()||{}, allC = (await db.ref(`kalendarze/${activeSeasonId}`).once('value')).val()||{}, scores = {};
        
        // 1. Zliczanie punkt√≥w (tak jak by≈Ço)
        Object.values(allC).forEach(c => {
            if(c.standings && c.standings[gid]) {
                getRanks(Object.values(allR[c.id] || {})).forEach(r => {
                    if(!scores[r.name]) scores[r.name] = { total: 0, w: 0, s: 0, t: 0 };
                    
                    if(r.rank === 1) scores[r.name].w++;
                    if(r.rank === 2) scores[r.name].s++;
                    if(r.rank === 3) scores[r.name].t++;

                    if(gSt?.type === 'fis') {
                        if(r.rank <= (c.qLimit||30)) scores[r.name].total += FIS_PTS[r.rank-1] || 0;
                    } else scores[r.name].total += (parseFloat(r.total)||0);
                });
            }
        });

        // 2. Sortowanie (od najwiƒôkszej liczby punkt√≥w)
        const sortedEntries = Object.entries(scores).sort((a,b) => b[1].total - a[1].total);

        // 3. Logika EGZEKWO (Ex aequo)
        let lastTotal = -999999; // Zmienna pomocnicza: wynik poprzednika
        let lastRank = 0;        // Zmienna pomocnicza: miejsce poprzednika

        return sortedEntries.map((s, i) => {
            const currentTotal = s[1].total;
            let rank;

            // Je≈õli wynik jest taki sam jak poprzednika -> to samo miejsce
            if (currentTotal === lastTotal) {
                rank = lastRank;
            } else {
                // Je≈õli inny -> miejsce wynika z kolejno≈õci w tabeli (i + 1)
                // Dziƒôki temu robi siƒô "przerwa" (np. 1, 1, 3)
                rank = i + 1;
            }

            // Zapamiƒôtaj dla nastƒôpnego skoczka w pƒôtli
            lastTotal = currentTotal;
            lastRank = rank;

            return {
                name: s[0], 
                total: currentTotal, 
                w: s[1].w, 
                s: s[1].s, 
                t: s[1].t, 
                pos: rank // Tutaj wstawiamy obliczone miejsce
            };
        });
    
        
        // Zwracamy obiekt, kt√≥ry MA w sobie w, s, t - dziƒôki temu zniknie 'undefined'
        return Object.entries(scores).sort((a,b) => b[1].total - a[1].total).map((s,i) => ({
            name: s[0], 
            total: s[1].total, 
            w: s[1].w, 
            s: s[1].s, 
            t: s[1].t, 
            pos: i+1
        }));
    }

    async function viewStanding(gid, name) {
    currentStandingId = gid;
    showPage('page-standings-view'); 
    document.getElementById('st-view-title').innerText = name;
    
    const sorted = await getCalculatedStanding(gid);
    const gSt = (await db.ref('global_klasyfikacje/'+gid).once('value')).val();
    
    const isFinished = (await db.ref(`sezony/${activeSeasonId}/finished_standings/${gid}`).once('value')).val();
    document.getElementById('st-status-info').classList.toggle('hidden', !isFinished);
    
    // Nag≈Ç√≥wek tabeli
    document.getElementById('st-view-head').innerHTML = `
        <th>Poz.</th>
        <th>Zawodnik</th>
        <th>Strata</th>
        <th style="width:35px; color:gold; text-align:center;">ü•á</th>
        <th style="width:35px; color:silver; text-align:center;">ü•à</th>
        <th style="width:35px; color:#cd7f32; text-align:center;">ü•â</th>
        <th>Wynik</th>`;
    
    const b = document.getElementById('st-view-body'); 
    b.innerHTML = '';
    const leaderTotal = sorted.length > 0 ? sorted[0].total : 0;

    sorted.forEach(s => { 
        const strata = s.pos === 1 ? "---" : (s.total - leaderTotal).toFixed(gSt?.type==='notes'?1:0);
        
        // TUTAJ BY≈Å B≈ÅƒÑD - brakowa≈Ço td dla s.w, s.s i s.t
        b.innerHTML += `
            <tr>
                <td>${s.pos}</td>
                <td>${s.name}</td>
                <td style="color:#666; font-size:0.8rem;">${strata}</td>
                <td>${s.w}</td>
                <td>${s.s}</td>
                <td>${s.t}</td>
                <td><b>${s.total.toFixed(gSt?.type==='notes'?1:0)}</b></td>
            </tr>`; 
    });
}
   async function finalizeStanding() {
        if(!isAdmin) return;
        if(!confirm("Czy na pewno chcesz zako≈Ñczyƒá ten ranking? Wyniki zostanƒÖ trwale zapisane w profilach zawodnik√≥w.")) return;
        
        const gSt = (await db.ref('global_klasyfikacje/'+currentStandingId).once('value')).val();
        const seasonName = document.getElementById('tiles-title').innerText;
        
        // Pobieramy przeliczony ranking (ten sam co w tabeli, z ex aequo)
        const sorted = await getCalculatedStanding(currentStandingId);
        
        let count = 0;
        for (let s of sorted) {
            const jumper = globalSkoczkowie.find(j => j.name === s.name);
            if(jumper) {
                const record = {
                    seasonName: seasonName,
                    standingName: gSt.name,
                    rank: s.pos, // <-- KLUCZOWE: U≈ºywamy s.pos (obliczone ex aequo), a nie indeksu pƒôtli
                    score: s.total.toFixed(gSt.type==='notes'?1:0)
                };
                
                // Zapisujemy do profilu
                await db.ref(`skoczkowie/${jumper.id}/historia_rankingow`).push(record);
                count++;
            }
        }
        
        // Oznaczamy jako zako≈Ñczony
        await db.ref(`sezony/${activeSeasonId}/finished_standings/${currentStandingId}`).set(true);
        
        alert(`Ranking zako≈Ñczony! Zapisano wyniki dla ${count} zawodnik√≥w.`);
        viewStanding(currentStandingId, gSt.name);
    }

    async function resumeStanding() {
        if(!isAdmin) return;
        if(!confirm("UWAGA: Wznowienie usunie przyznane wyniki tego rankingu z profili skoczk√≥w. Czy chcesz kontynuowaƒá?")) return;
        
        const seasonName = document.getElementById('tiles-title').innerText;
        const gSt = (await db.ref('global_klasyfikacje/'+currentStandingId).once('value')).val();
        const standingName = gSt.name;

        const allJumpersSnap = await db.ref('skoczkowie').once('value');
        const allJumpers = allJumpersSnap.val() || {};
        const updates = {};

        let deletedCount = 0;
        for (const [jumperId, jumperData] of Object.entries(allJumpers)) {
            if (jumperData.historia_rankingow) {
                for (const [recId, record] of Object.entries(jumperData.historia_rankingow)) {
                    if (record.seasonName === seasonName && record.standingName === standingName) {
                        updates[`skoczkowie/${jumperId}/historia_rankingow/${recId}`] = null;
                        deletedCount++;
                    }
                }
            }
        }

        updates[`sezony/${activeSeasonId}/finished_standings/${currentStandingId}`] = null;
        await db.ref().update(updates);
        alert(`Ranking wznowiony. Usuniƒôto ${deletedCount} wpis√≥w z profili.`);
        viewStanding(currentStandingId, standingName);
    }

    // --- PROFIL (ZLICZANIE TYLKO Z≈ÅOTA DLA IO, M≈ö, M≈öL) ---
   async function openProfile(name) {
    showPage('page-profile');
    document.getElementById('prof-name').innerText = name;

    // Zmienne do statystyk
    let hist = [],
        s = {
            wins: [],
            pods: [],
            hillDom: {},
            io_all: [],
            io_gold: 0,
            ms_all: [],
            ms_gold: 0,
            msl_all: [],
            msl_gold: 0
        };

    // --- NOWE: Zmienna do Rekordu ≈ªyciowego ---
    let calculatedPB = 0;
    // ------------------------------------------

    const allR = (await db.ref('wyniki').once('value')).val() || {},
          allC = (await db.ref('kalendarze').once('value')).val() || {};

    const jumperObj = globalSkoczkowie.find(j => j.name === name);
    const finalStandingsDiv = document.getElementById('prof-final-records-global');
    finalStandingsDiv.innerHTML = '≈Åadowanie...';

    // Historia ranking√≥w (bez zmian)
    if (jumperObj) {
        db.ref(`skoczkowie/${jumperObj.id}/historia_rankingow`).once('value', sn => {
            const h = sn.val();
            if (!h) {
                finalStandingsDiv.innerHTML = 'Brak wpis√≥w archiwalnych.';
                return;
            }
            let html = '<table><thead><tr><th>Sezon</th><th>Ranking</th><th>Miejsce</th><th class="col-total">Nota</th></tr></thead><tbody>';
            Object.values(h).sort((a, b) => b.seasonName.localeCompare(a.seasonName)).forEach(rec => {
                let color = rec.rank == 1 ? '#ffd700' : (rec.rank == 2 ? '#c0c0c0' : (rec.rank == 3 ? '#cd7f32' : 'inherit'));
                let weight = rec.rank <= 3 ? 'bold' : 'normal';
                html += `<tr style="color:${color}; font-weight:${weight}"><td>${rec.seasonName}</td><td>${rec.standingName}</td><td>${rec.rank}</td><td>${rec.score}</td></tr>`;
            });
            html += '</tbody></table>';
            finalStandingsDiv.innerHTML = html;
        });
    } else {
        finalStandingsDiv.innerHTML = 'Brak powiƒÖzanego konta.';
    }

    // PƒòTLA G≈Å√ìWNA (Skanowanie wynik√≥w)
    for (let sid in allC) {
        for (let cid in allC[sid]) {
            const comp = allC[sid][cid],
                  ranked = getRanks(Object.values(allR[cid] || {}));

            // Pomijamy treningi w statystykach, ALE rekord ≈ºyciowy sprawdzamy wszƒôdzie (nawet na treningu/kwali)
            // Je≈õli nie chcesz uwzglƒôdniaƒá trening√≥w w PB, dodaj warunek w sekcji poni≈ºej.

            ranked.forEach(r => {
                // Sprawdzamy czy to ten zawodnik
                const isMain = r.name === name;
                const isSecond = r.name2 === name; // Dla duet√≥w (jako zawodnik B)

                if (isMain || isSecond) {
                    
                    // --- SEKCJA: Obliczanie PB (Skanujemy ka≈ºdƒÖ seriƒô) ---
                    const fieldsToCheck = isMain ? ['s1', 's2', 's3', 's4'] : ['s1_b', 's2_b', 's3_b', 's4_b'];
                    
                    fieldsToCheck.forEach(f => {
                        const val = parseFloat(r[f]);
                        if (!isNaN(val) && val > calculatedPB) {
                            calculatedPB = val;
                        }
                    });
                    // -----------------------------------------------------

                    // Dalsza czƒô≈õƒá statystyk (tylko dla g≈Ç√≥wnego typu i g≈Ç√≥wnego nazwiska, ≈ºeby nie psuƒá wykres√≥w)
                    if (comp.type === 'kwali' || comp.type === 'trening' || comp.type === 'duety') return;
                    if (!isMain) return; 

                    const e = `${comp.date}: <b>${r.rank}.</b> (${comp.loc})`;
                    hist.push({ d: comp.date, l: comp.loc, r: r.rank });

                    if (comp.type === 'konkurs') {
                        if (r.rank === 1) {
                            s.wins.push(e);
                            s.hillDom[comp.loc] = (s.hillDom[comp.loc] || 0) + 1;
                        }
                        if (r.rank <= 3) s.pods.push(e);
                    }

                    if (comp.type === 'io') {
                        s.io_all.push(e);
                        if (r.rank === 1) s.io_gold++;
                    }
                    if (comp.type === 'ms') {
                        s.ms_all.push(e);
                        if (r.rank === 1) s.ms_gold++;
                    }
                    if (comp.type === 'msl') {
                        s.msl_all.push(e);
                        if (r.rank === 1) s.msl_gold++;
                    }
                }
            });
        }
    }

    // --- WY≈öWIETLANIE REKORDU ≈ªYCIOWEGO ---
    // Pobieramy manualny rekord z obiektu skoczka
    const manualPB = jumperObj && jumperObj.manualPB ? parseFloat(jumperObj.manualPB) : 0;
    // Wybieramy wiƒôkszy: obliczony vs manualny
    const finalPB = Math.max(calculatedPB, manualPB);

    // Wstrzykujemy kartƒô z rekordem na g√≥rƒô profilu (lub w dowolne miejsce, tutaj dodajƒô nad HistoriƒÖ Start√≥w)
    // Budujemy HTML karty rekordu
    const pbCardHtml = `
        <div class="card" style="background: linear-gradient(135deg, #003366, #00509e); color: white; text-align: center; margin-bottom: 20px;">
            <h3 style="margin:0; font-size:1.1rem; opacity:0.9;">üöÄ REKORD ≈ªYCIOWY</h3>
            <div style="font-size: 3rem; font-weight: bold; margin: 10px 0; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                ${finalPB.toFixed(1)} m
            </div>
            <div class="admin-only ${isAdmin ? '' : 'hidden'}" style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; font-size: 0.85rem;">
                üõ†Ô∏è Admin Override (Minimum): 
                <input type="number" step="0.5" 
                    value="${manualPB}" 
                    style="width: 70px; padding: 4px; border-radius: 4px; border: none; text-align: center;" 
                    onchange="updateManualPB('${jumperObj ? jumperObj.id : ''}', this.value)">
                <div style="font-size:0.7rem; color:#ccc; margin-top:2px;">(Wpisz 0 aby zresetowaƒá do auto)</div>
            </div>
        </div>
    `;

    // Renderowanie list historycznych
    hist.sort((a, b) => b.d.localeCompare(a.d));
    document.getElementById('prof-history-10').innerHTML = hist.slice(0, 10).map(x => `<tr><td>${x.d}</td><td>${x.l}</td><td><b>${x.r}</b></td></tr>`).join('');
    document.getElementById('prof-history-full').innerHTML = hist.slice(10).map(x => `<tr><td>${x.d}</td><td>${x.l}</td><td><b>${x.r}</b></td></tr>`).join('');

    document.getElementById('c-wins').innerText = s.wins.length;
    document.getElementById('prof-wins').innerHTML = s.wins.join('<br>') || 'Brak';
    document.getElementById('c-pods').innerText = s.pods.length;
    document.getElementById('prof-pods').innerHTML = s.pods.join('<br>') || 'Brak';

    document.getElementById('c-io').innerText = s.io_gold;
    document.getElementById('prof-io-list').innerHTML = s.io_all.join('<br>') || 'Brak start√≥w';
    document.getElementById('ms-count').innerText = s.ms_gold;
    document.getElementById('prof-ms-list').innerHTML = s.ms_all.join('<br>') || 'Brak start√≥w';
    document.getElementById('msl-count').innerText = s.msl_gold;
    document.getElementById('prof-msl-list').innerHTML = s.msl_all.join('<br>') || 'Brak start√≥w';

    const chartDiv = document.getElementById('prof-hills-chart');
    chartDiv.innerHTML = '';
    const sortedHills = Object.entries(s.hillDom).sort((a, b) => b[1] - a[1]);
    if (sortedHills.length > 0) {
        sortedHills.forEach(([loc, count]) => {
            chartDiv.innerHTML += `<div>${loc} (Wygrane: ${count})<div class="stat-bar-container"><div class="stat-bar-fill" style="width:${Math.min((count / 5) * 100, 100)}%"></div></div></div>`;
        });
    } else {
        chartDiv.innerHTML = 'Brak zwyciƒôstw.';
    }

    const myRecs = globalHills.filter(h => (h.recKoAuth || "").split(',').map(s => s.trim()).includes(name));
    document.getElementById('prof-rec-list').innerHTML = myRecs.length > 0
        ? myRecs.map(h => `<div>${h.name}: <b>${h.recKoDist}m</b></div>`).join('')
        : 'Brak rekord√≥w skoczni.';

    db.ref('osiagniecia_specjalne').once('value', sr => {
        document.getElementById('prof-special-records').innerHTML = Object.values(sr.val() || {}).filter(x => x.name === name).map(x => `‚≠ê ${x.text}`).join('<br>') || 'Brak';
    });

    // --- WSTRZYKNIƒòCIE KARTY REKORDU DO DOM ---
    // Najpierw czy≈õcimy ew. stare wstrzykniƒôcia je≈õli u≈ºywasz `prepend`
    const grid = document.querySelector('#page-profile .event-grid');
    
    // Sprytny spos√≥b na wstawienie tego nad siatkƒÖ statystyk ("event-grid"), 
    // ale pod nag≈Ç√≥wkiem imienia.
    const existingPbCard = document.getElementById('pb-card-dynamic');
    if(existingPbCard) existingPbCard.remove();
    
    const pbContainer = document.createElement('div');
    pbContainer.id = 'pb-card-dynamic';
    pbContainer.innerHTML = pbCardHtml;
    
    // Wstawiamy po nag≈Ç√≥wku H1
    const h1Name = document.getElementById('prof-name');
    h1Name.parentNode.insertBefore(pbContainer, h1Name.nextSibling);
}

    // --- SYSTEMOWE ---
    function addNewCompetitionDirectly() {
        if(!activeSeasonId) return alert("B≈ÇƒÖd: Otw√≥rz sezon!");
        const newRef = db.ref('kalendarze').child(activeSeasonId).push();
        newRef.set({ id: newRef.key, date: "2026-01-01", type: "konkurs", loc: "Wybierz...", qLimit: 30 });
    }

    function addHill() {
        const id = "h_" + Date.now(), hs = document.getElementById('h-hs-val').value;
        const name = document.getElementById('h-name-base').value + " HS " + hs;
        db.ref('skocznie/'+id).set({ id, name, hs, k: document.getElementById('h-k-val').value, recKoAuth: document.getElementById('h-rk-auth').value, recKoDist: document.getElementById('h-rk-dist').value, recRealAuth: document.getElementById('h-rr-auth').value, recRealDist: document.getElementById('h-rr-dist').value });
    }

    // STRICT RENDERING: HILLS
    function refreshHillList(data) {
        const b = document.getElementById('hill-list'); b.innerHTML = '';
        const isEdit = isAdmin ? 'contenteditable="true" class="editable-cell"' : '';
        data.forEach(h => {
            b.innerHTML += `<tr><td ${isEdit} onblur="if(isAdmin) db.ref('skocznie/${h.id}').update({name:this.innerText})">${h.name}</td>
                <td>HS: <span ${isEdit} onblur="if(isAdmin) db.ref('skocznie/${h.id}').update({hs:this.innerText})">${h.hs}</span> / K: <span ${isEdit} onblur="if(isAdmin) db.ref('skocznie/${h.id}').update({k:this.innerText})">${h.k}</span></td>
                <td><span ${isEdit} onblur="if(isAdmin) db.ref('skocznie/${h.id}').update({recKoAuth:this.innerText})">${h.recKoAuth}</span> (<span ${isEdit} onblur="if(isAdmin) db.ref('skocznie/${h.id}').update({recKoDist:this.innerText})">${h.recKoDist}</span>m)</td>
                <td><span ${isEdit} onblur="if(isAdmin) db.ref('skocznie/${h.id}').update({recRealAuth:this.innerText})">${h.recRealAuth}</span> (<span ${isEdit} onblur="if(isAdmin) db.ref('skocznie/${h.id}').update({recRealDist:this.innerText})">${h.recRealDist}</span>m)</td>
                <td class="${isAdmin?'':'hidden'}"><button class="btn btn-del" onclick="db.ref('skocznie/${h.id}').remove()">X</button></td></tr>`;
        });
        const listDiv = document.getElementById('suggestions-h-rk');
        if(listDiv) listDiv.innerHTML = globalSkoczkowie.map(sk => `<div class="suggestion-item" onclick="document.getElementById('h-rk-auth').value='${sk.name}'; this.parentElement.style.display='none'">${sk.name}</div>`).join('');
    }

    function addResultRow() {
        const key = db.ref('wyniki/'+activeCompId).push().key;
        db.ref('wyniki/'+activeCompId+'/'+key).set({id: key, name: "Wybierz...", s1: '-', s2: '-', s3: '-', s4: '-', total: 0});
    }

    // STRICT RENDERING: RESULTS
  
 function refreshResultsView() {
    db.ref(`kalendarze/${activeSeasonId}/${activeCompId}`).on('value', compSnap => {
        const compData = compSnap.val() || {};
        const qL = compData.qLimit || 30;

        db.ref('wyniki/'+activeCompId).on('value', s => {
            const data = Object.values(s.val()||{}).filter(x => x && x.id);
            const ranked = getRanks([...data]);
            const leaderScore = ranked.length > 0 ? (parseFloat(ranked[0].total) || 0) : 0;
            
            const b = document.getElementById('results-body'); b.innerHTML = '';
            
            // PRECYZYJNE UKRYWANIE KOLUMN
            document.querySelectorAll('.s3-col').forEach(el => (activeType === 'msl' || activeType === 'duety') ? el.classList.remove('hidden') : el.classList.add('hidden'));
            document.querySelectorAll('.s4-col').forEach(el => (activeType === 'msl') ? el.classList.remove('hidden') : el.classList.add('hidden'));
            document.querySelectorAll('.s2-col').forEach(el => (activeType==='kwali' || activeType==='trening') ? el.classList.add('hidden') : el.classList.remove('hidden'));

            ranked.forEach(r => {
                const currentTotal = parseFloat(r.total) || 0;
                const strata = r.rank === 1 ? "---" : (currentTotal - leaderScore).toFixed(1);
                
                let nameCell = "";
                if (activeType === 'duety') {
                    nameCell = isAdmin 
                        ? `<div style="display:flex; flex-direction:column; gap:4px;">
                             <input type="text" class="search-input" value="${r.name||''}" placeholder="Skoczek 1" oninput="filterLocalList(this, 'l1-${r.id}')" onfocus="document.getElementById('l1-${r.id}').style.display='block'">
                             <div id="l1-${r.id}" class="suggestions-list">${globalSkoczkowie.map(sk => `<div class="suggestion-item" onclick="confirmJumper('${r.id}', '${sk.name}')">${sk.name}</div>`).join('')}</div>
                             <input type="text" class="search-input" value="${r.name2||''}" placeholder="Skoczek 2" oninput="filterLocalList(this, 'l2-${r.id}')" onfocus="document.getElementById('l2-${r.id}').style.display='block'">
                             <div id="l2-${r.id}" class="suggestions-list">${globalSkoczkowie.map(sk => `<div class="suggestion-item" onclick="confirmJumper2('${r.id}', '${sk.name}')">${sk.name}</div>`).join('')}</div>
                           </div>`
                        : `<b>${r.name}</b><br><b>${r.name2||'---'}</b>`;
                } else {
                    nameCell = isAdmin 
                        ? `<div class="dropdown-wrapper"><input type="text" class="search-input" value="${r.name}" oninput="filterLocalList(this, 'list-${r.id}')" onfocus="document.getElementById('list-${r.id}').style.display='block'"><div id="list-${r.id}" class="suggestions-list">${globalSkoczkowie.map(sk => `<div class="suggestion-item" onclick="confirmJumper('${r.id}', '${sk.name}')">${sk.name}</div>`).join('')}</div></div>`
                        : `<b>${r.name}</b>`;
                }

                const editAttr = isAdmin ? 'contenteditable="true"' : '';
                
                // POMOCNIK RENDEROWANIA SERII (Z PRZYWR√ìCONYM ONFOCUS)
                const renderSerie = (f1, f2, extraClass = '') => {
                    if (activeType === 'duety') {
                        return `<td class="${extraClass}">
                                    <div style="font-size:0.75rem; color:#888;">A:</div>
                                    <div ${editAttr} onfocus="liveToBeat('${r.id}','${f1}',${leaderScore})" onblur="calcResDuet('${r.id}','${f1}',this.innerText)">${r[f1]||'-'}</div>
                                    <div style="font-size:0.75rem; color:#888; border-top:1px solid #eee; margin-top:2px;">B:</div>
                                    <div ${editAttr} onfocus="liveToBeat('${r.id}','${f2}',${leaderScore})" onblur="calcResDuet('${r.id}','${f2}',this.innerText)">${r[f2]||'-'}</div>
                                </td>`;
                    } else {
                        return `<td class="${extraClass}" ${editAttr} onfocus="liveToBeat('${r.id}','${f1}',${leaderScore})" onblur="calcRes('${r.id}','${f1}',this.innerText)">${r[f1]||'-'}</td>`;
                    }
                };

                let row = `<tr><td>${r.rank}${ (r.rank <= qL && activeType !== 'duety') ? '<span class="q-badge">[Q]</span>' : '' }</td><td>${nameCell}</td>`;
                row += renderSerie('s1', 's1_b');
                if(activeType !== 'kwali' && activeType !== 'trening') row += renderSerie('s2', 's2_b', 's2-col');
                if(activeType === 'msl' || activeType === 'duety') row += renderSerie('s3', 's3_b', 's3-col');
                if(activeType === 'msl') row += renderSerie('s4', 's4_b', 's4-col');

                row += `<td>${strata}</td><td class="col-total">${currentTotal.toFixed(1)}</td>`;
                row += `<td class="admin-only ${isAdmin?'':'hidden'} col-action"><button class="btn btn-del" onclick="db.ref('wyniki/${activeCompId}/${r.id}').remove()">X</button></td></tr>`;
                
                b.innerHTML += row;
            });
        });
    });
}   window.filterLocalList = function(i, lId) { const v = i.value.toUpperCase(); const l = document.getElementById(lId); l.style.display = 'block'; Array.from(l.children).forEach(d => { d.style.display = d.innerText.toUpperCase().includes(v) ? 'block' : 'none'; }); };
    window.confirmJumper = function(rId, n) { db.ref(`wyniki/${activeCompId}/${rId}`).update({name: n}); };
window.confirmJumper2 = function(rId, n) { 
    db.ref(`wyniki/${activeCompId}/${rId}`).update({name2: n}); 
};
    window.confirmHill = function(cId, n) { db.ref(`kalendarze/${activeSeasonId}/${cId}`).update({loc: n}); };
   function showPage(p) {
    // 1. Ukryj wszystkie strony
    document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden'));
    
    // 2. Poka≈º wybranƒÖ stronƒô
    document.getElementById(p).classList.remove('hidden');

    // --- LOGIKA RESETOWANIA MOTYWU IO ---
    // Je≈õli wchodzimy na stronƒô innƒÖ ni≈º wyniki (np. kalendarz, menu g≈Ç√≥wne), czy≈õcimy motyw
    if (p !== 'page-results') {
        document.body.classList.remove('io-active'); // Usuwa klasƒô z body
        document.body.style.background = "var(--light)"; // Przywraca jasne t≈Ço
        
        // Resetujemy te≈º klasƒô w samym divie wynik√≥w na wszelki wypadek
        const pageRes = document.getElementById('page-results');
        if(pageRes) pageRes.classList.remove('theme-io');
    }
    // -------------------------------------

    if (p === 'page-standings-selection') refreshStandingsSelection();
    if (p === 'page-galeria') renderHallOfFame();
}
    function openSeason(id, n) { activeSeasonId = id; document.getElementById('tiles-title').innerText = n; showPage('page-season-tiles'); db.ref('kalendarze/'+id).on('value', s => renderCalendar(Object.values(s.val()||{}))); }
    function addSeason() { const n = prompt("Nazwa:"); if(n) db.ref('sezony/'+Date.now()).set({id:Date.now().toString(), name:n}); }
    function addSkoczek() { const n=prompt("Imiƒô:"); if(n) db.ref('skoczkowie/'+Date.now()).set({id: Date.now().toString(), name:n}); }
    function createGlobalStanding() { const n = document.getElementById('global-st-name').value, t = document.getElementById('global-st-type').value; if(n) db.ref('global_klasyfikacje').push({name:n, type:t}).then(()=>document.getElementById('global-st-name').value=''); }
    function addSpecialRecord() { const n=document.getElementById('rec-name-in').value, t=document.getElementById('rec-text-in').value; if(n && t) db.ref('osiagniecia_specjalne').push({name:n, text:t}).then(()=>document.getElementById('rec-text-in').value=''); }
    
    // SAVE FUNCTION (SECURE)
    function calcRes(rid, f, v) { 
        if(!isAdmin) return; // SECURITY CHECK
        let val = v.trim()==='-'?'-':parseFloat(v.replace(',','.'))||0; 
        db.ref(`wyniki/${activeCompId}/${rid}`).update({[f]:val}).then(()=>{ db.ref(`wyniki/${activeCompId}/${rid}`).once('value', s=>{ let d=s.val(), sum=0; ['s1','s2','s3','s4'].forEach(x=>{ if(d[x]!=='-' && d[x]!==undefined) sum+=parseFloat(d[x]||0); }); db.ref(`wyniki/${activeCompId}/${rid}`).update({total:sum}); }); }); 
    }

    // LIVE TO BEAT - ADMIN SENDS, EVERYONE SEES
    function liveToBeat(rid, field, leader) { 
    if(!isAdmin) return; 
    db.ref(`wyniki/${activeCompId}/${rid}`).once('value', s => { 
        const d = s.val(); 
        if(!d) return; 
        
        // Logika sumowania wszystkiego, co by≈Ço PRZED aktualnie klikniƒôtym polem
        let sumaPrzed = 0;
        const order = ['s1', 's1_b', 's2', 's2_b', 's3', 's3_b', 's4'];
        for (let f of order) {
            if (f === field) break;
            sumaPrzed += parseFloat(d[f] || 0);
        }

        const needed = (leader - sumaPrzed).toFixed(1);
        
        // Wykrywamy kto aktualnie skacze dla komunikatu
        let jumperName = (field.endsWith('_b')) ? (d.name2 || "Skoczek B") : (d.name || "Skoczek A");
        
        db.ref('status/liveToBeat').set(`Aby prowadziƒá: ${needed} m (Skacze: ${jumperName})`);
    }); 
}
    
    function updateQLimit(v) { db.ref(`kalendarze/${activeSeasonId}/${activeCompId}/qLimit`).set(parseInt(v)); }
    function toggleStatList(id) { const el = document.getElementById(id); el.style.display = (el.style.display==='block')?'none':'block'; }

    // STRICT RENDERING: CALENDAR
  function renderCalendar(data) { 
    const b = document.getElementById('calendar-body'); b.innerHTML = ''; 
    data.sort((a,b)=>a.date.localeCompare(b.date)).forEach(c => { 
        // Secure Loc Input
        let locCell = '';
        if(isAdmin) {
            locCell = `<div class="dropdown-wrapper"><input type="text" class="search-input" value="${c.loc}" oninput="filterLocalList(this, 'list-h-${c.id}')" onfocus="document.getElementById('list-h-${c.id}').style.display='block'"><div id="list-h-${c.id}" class="suggestions-list">${globalHills.map(h => `<div class="suggestion-item" onclick="confirmHill('${c.id}', '${h.name}')">${h.name}</div>`).join('')}</div></div>`;
        } else {
            locCell = c.loc;
        }

        // --- NOWO≈öƒÜ: Wyb√≥r grafiki (theme) ---
        const themeSelect = isAdmin ? `
            <select style="font-size:0.8rem; margin-top:5px; border:1px solid #aaa;" onchange="db.ref('kalendarze/${activeSeasonId}/${c.id}').update({theme:this.value})">
                <option value="normal" ${c.theme!=='io'?'selected':''}>üì∫ Standard</option>
                <option value="io" ${c.theme==='io'?'selected':''}>üîµ Igrzyska (IO)</option>
            </select>
        ` : '';
        // -------------------------------------

        b.innerHTML += `<tr>
            <td contenteditable="${isAdmin}" onblur="if(isAdmin) db.ref('kalendarze/${activeSeasonId}/${c.id}').update({date:this.innerText})">${c.date}</td>
            <td>
                <select class="${isAdmin?'':'hidden'}" onchange="db.ref('kalendarze/${activeSeasonId}/${c.id}').update({type:this.value})">
                    <option value="konkurs" ${c.type==='konkurs'?'selected':''}>Konkurs</option>
                    <option value="kwali" ${c.type==='kwali'?'selected':''}>Kwalifikacje</option>
                    <option value="trening" ${c.type==='trening'?'selected':''}>Trening</option>
                    <option value="duety" ${c.type==='duety'?'selected':''}>Duety</option>
                    <option value="ms" ${c.type==='ms'?'selected':''}>M≈ö</option>
                    <option value="io" ${c.type==='io'?'selected':''}>IO</option>
                    <option value="msl" ${c.type==='msl'?'selected':''}>M≈öL</option>
                </select>
                <span class="${isAdmin?'hidden':''}">${c.type.toUpperCase()}</span>
                <br>${themeSelect} </td>
            <td>${locCell}</td>
            <td><button class="btn" style="background:var(--primary); color:white;" onclick="openResults('${c.id}','${c.loc}','${c.type}', '${c.theme||'normal'}')">Wyniki</button> ${isAdmin?`<button class="btn btn-del" onclick="db.ref('kalendarze/${activeSeasonId}/${c.id}').remove()">X</button>`:''}</td>
        </tr>`; 
    }); 
}

    // RECORDS RENDERING (WITH DELETE BTN)
    db.ref('osiagniecia_specjalne').on('value', s => refreshRecordsList(s.val()));

    function refreshRecordsList(data) {
        const d = document.getElementById('global-records-list');
        d.innerHTML = '';
        if(!data) return;
        
        Object.entries(data).forEach(([key, r]) => {
            const delBtn = isAdmin ? `<button class="btn btn-del" style="margin-left:auto" onclick="db.ref('osiagniecia_specjalne/${key}').remove()">X</button>` : '';
            d.innerHTML += `<div class="card" style="padding:10px; display:flex; align-items:center;">
                <span>‚≠ê <b>${r.name}</b>: ${r.text}</span>
                ${delBtn}
            </div>`;
        });
    }

    db.ref('sezony').on('value', s => { const list = document.getElementById('seasons-list'); list.innerHTML = ''; Object.values(s.val()||{}).forEach(sez => list.innerHTML += `<div class="card" style="display:flex; justify-content:space-between; align-items:center;"><b>${sez.name}</b><div><button class="btn" onclick="openSeason('${sez.id}','${sez.name}')">Otw√≥rz</button> <button class="btn btn-del admin-only ${isAdmin?'':'hidden'}" onclick="db.ref('sezony/${sez.id}').remove()">X</button></div></div>`); });
    db.ref('skoczkowie').on('value', s => { globalSkoczkowie=Object.values(s.val()||{}); const b=document.getElementById('skoczkowie-list'); if(b) { b.innerHTML=''; globalSkoczkowie.forEach(sk=>b.innerHTML+=`<tr><td>${sk.name}</td><td><button class="btn" onclick="openProfile('${sk.name}')">Profil</button></td><td class="admin-only ${isAdmin?'':'hidden'}"><button class="btn-del" onclick="db.ref('skoczkowie/${sk.id}').remove()">X</button></td></tr>`); } });
    db.ref('skocznie').on('value', s => { globalHills = Object.values(s.val()||{}); refreshHillList(globalHills); });
    
    db.ref('global_klasyfikacje').on('value', s => { const adminL = document.getElementById('global-standings-admin-list'); if(adminL) { adminL.innerHTML = ''; Object.entries(s.val()||{}).forEach(([id, st]) => adminL.innerHTML += `<div class="card" style="padding:10px;"><b>${st.name}</b> <button class="btn-del" onclick="db.ref('global_klasyfikacje/${id}').remove()">X</button></div>`); } });
   async function openResults(id, loc, type, theme) {
    activeCompId = id;
    activeType = type;

    const pageRes = document.getElementById('page-results');
    
    // --- ZMIANA MOTYWU (AKTUALIZACJA) ---
    if (theme === 'io') {
        // Dodajemy klasƒô do BODY - to uruchamia zmianƒô kontenera na przezroczysty
        document.body.classList.add('io-active'); 
        document.body.style.background = "#001a33"; // Ciemne t≈Ço strony
        
        // Dodajemy styl do tabeli
        pageRes.classList.add('theme-io');
    } else {
        // Tryb standardowy
        document.body.classList.remove('io-active');
        document.body.style.background = "var(--light)";
        pageRes.classList.remove('theme-io');
    }
    // ------------------------------------

    document.getElementById('current-comp-title').innerText = loc;
    showPage('page-results');
    refreshResultsView();

    // Checkboxy (bez zmian)
    const gL = (await db.ref('global_klasyfikacje').once('value')).val() || {};
    const compD = (await db.ref(`kalendarze/${activeSeasonId}/${id}`).once('value')).val() || {};
    const checkB = document.getElementById('global-checkboxes');
    checkB.innerHTML = '';
    Object.entries(gL).forEach(([gid, st]) => {
        const isC = compD.standings && compD.standings[gid] ? 'checked' : '';
        checkB.innerHTML += `<label style="margin-left:10px;"><input type="checkbox" ${isC} onchange="db.ref('kalendarze/${activeSeasonId}/${activeCompId}/standings/${gid}').set(this.checked?true:null)"> ${st.name}</label>`;
    });
}
    async function refreshStandingsSelection() { const gL = (await db.ref('global_klasyfikacje').once('value')).val() || {}, list = document.getElementById('standings-user-list'); if(!list) return; list.innerHTML = ''; Object.entries(gL).forEach(([gid, st]) => { list.innerHTML += `<div class="card" style="display:flex; justify-content:space-between; align-items:center;"><b>${st.name}</b><button class="btn" style="background:var(--primary); color:white;" onclick="viewStanding('${gid}','${st.name}')">Ranking</button></div>`; }); }

    document.addEventListener('click', e => { if(!e.target.classList.contains('search-input')) document.querySelectorAll('.suggestions-list').forEach(d => d.style.display = 'none'); });
// Globalna zmienna do obs≈Çugi "Poka≈º wiƒôcej"
let hofExpanded = {};

// 1. Inicjalizacja i agregacja danych
async function renderHallOfFame() {
    const allR = (await db.ref('wyniki').once('value')).val() || {};
    const allC = (await db.ref('kalendarze').once('value')).val() || {};
    // Pobieramy te≈º listƒô skoczk√≥w, by mieƒá dostƒôp do manualPB
    const allJumpers = globalSkoczkowie; 

    const stats = {}; // Statystyki zwyciƒôstw/podi√≥w
    const pbStats = {}; // Statystyki rekord√≥w ≈ºyciowych { "Nazwa": odleglosc }

    // Funkcja pomocnicza do aktualizacji PB
    const checkDist = (name, val) => {
        const d = parseFloat(val);
        if (!isNaN(d)) {
            if (!pbStats[name]) pbStats[name] = 0;
            if (d > pbStats[name]) pbStats[name] = d;
        }
    };

    // 1. Przeszukujemy wszystkie wyniki (Zwyciƒôstwa, Podia i Wyniki skok√≥w)
    for (let sid in allC) {
        for (let cid in allC[sid]) {
            const comp = allC[sid][cid];
            // Pobieramy wyniki i sortujemy je
            const rawResults = Object.values(allR[cid] || {});
            const ranked = getRanks(rawResults);

            ranked.forEach(r => {
                // --- LOGIKA STATYSTYK TYTU≈Å√ìW (BEZ ZMIAN) ---
                if (comp.type !== 'duety') {
                    if (!stats[r.name]) stats[r.name] = { psWins: 0, psPods: 0, ioGold: 0, msGold: 0, mslGold: 0 };
                    
                    if (comp.type === 'konkurs') {
                        if (r.rank === 1) stats[r.name].psWins++;
                        if (r.rank <= 3) stats[r.name].psPods++;
                    }
                    if (comp.type === 'io' && r.rank === 1) stats[r.name].ioGold++;
                    if (comp.type === 'ms' && r.rank === 1) stats[r.name].msGold++;
                    if (comp.type === 'msl' && r.rank === 1) stats[r.name].mslGold++;
                }

                // --- LOGIKA REKORD√ìW ≈ªYCIOWYCH (NOWO≈öƒÜ) ---
                // Sprawdzamy g≈Ç√≥wnego zawodnika
                if (r.name) {
                    checkDist(r.name, r.s1);
                    checkDist(r.name, r.s2);
                    checkDist(r.name, r.s3);
                    checkDist(r.name, r.s4);
                }
                // Sprawdzamy drugiego zawodnika (je≈õli to duety)
                if (r.name2) {
                    checkDist(r.name2, r.s1_b);
                    checkDist(r.name2, r.s2_b);
                    checkDist(r.name2, r.s3_b);
                    checkDist(r.name2, r.s4_b);
                }
            });
        }
    }

    // 2. Uwzglƒôdniamy Manualne PB ustawione przez Admina
    allJumpers.forEach(j => {
        const manual = parseFloat(j.manualPB) || 0;
        const current = pbStats[j.name] || 0;
        if (manual > current) {
            pbStats[j.name] = manual;
        }
    });

    // --- RENDEROWANIE TABEL ---

    // Funkcja pomocnicza (bez zmian)
    const fillHofTable = (dataKey, bodyId) => {
        const sorted = Object.entries(stats)
            .map(([name, val]) => ({ name, val: val[dataKey] }))
            .filter(x => x.val > 0)
            .sort((a, b) => b.val - a.val);

        renderSortedTable(sorted, bodyId);
    };

    // Nowa funkcja renderujƒÖca tabelƒô (u≈ºywana te≈º do PB)
    const renderSortedTable = (sortedData, bodyId) => {
        const body = document.getElementById(bodyId);
        if(!body) return; // Zabezpieczenie
        
        const isExp = hofExpanded[bodyId];
        
        let lastVal = -1;
        let lastRank = 0;
        let html = '';

        sortedData.forEach((s, i) => {
            let currentRank = (s.val === lastVal) ? lastRank : i + 1;
            lastVal = s.val;
            lastRank = currentRank;

            if (isExp || i < 5) {
                // Dla PB formatujemy wynik z "m", dla reszty zwyk≈Ça liczba
                const valDisplay = bodyId === 'body-hof-pb' ? `<b>${s.val.toFixed(1)} m</b>` : s.val;
                html += `<tr><td>${currentRank}.</td><td><b>${s.name}</b></td><td>${valDisplay}</td></tr>`;
            }
        });
        body.innerHTML = html;
    };

    // Wype≈Çnianie standardowych tabel
    fillHofTable('psWins', 'body-hof-wins');
    fillHofTable('psPods', 'body-hof-pods');
    fillHofTable('ioGold', 'body-hof-io');
    fillHofTable('msGold', 'body-hof-ms');
    fillHofTable('mslGold', 'body-hof-msl');

    // Wype≈Çnianie tabeli PB
    const sortedPB = Object.entries(pbStats)
        .map(([name, val]) => ({ name, val }))
        .filter(x => x.val > 0)
        .sort((a, b) => b.val - a.val);
    
    renderSortedTable(sortedPB, 'body-hof-pb');

    renderHofDynamicTitles();
    updateHofAdminControls();
}

    

// 2. Dynamiczne tabele tytu≈Ç√≥w (dodawane przez admina)
async function renderHofDynamicTitles() {
    const hofTablesSnap = await db.ref('status/hall_of_fame_tables').once('value');
    const activeIds = hofTablesSnap.val() || {};
    const container = document.getElementById('hof-dynamic-titles');
    container.innerHTML = '';

    const allJumpers = (await db.ref('skoczkowie').once('value')).val() || {};
    
    for(let gid in activeIds) {
        let winners = {};
        Object.values(allJumpers).forEach(sk => {
            if(sk.historia_rankingow) {
                Object.values(sk.historia_rankingow).forEach(rec => {
                    if(rec.standingName === activeIds[gid] && parseInt(rec.rank) === 1) {
                        winners[sk.name] = (winners[sk.name] || 0) + 1;
                    }
                });
            }
        });

        const sortedWinners = Object.entries(winners).sort((a,b) => b[1] - a[1]);
        const bodyId = `body-dynamic-${gid}`;
        const isExp = hofExpanded[bodyId];

        let lastVal = -1;
        let lastRank = 0;
        let rowsHtml = '';

        sortedWinners.forEach((s, i) => {
            let currentRank = (s[1] === lastVal) ? lastRank : i + 1;
            lastVal = s[1];
            lastRank = currentRank;

            if (isExp || i < 5) {
                rowsHtml += `<tr><td>${currentRank}.</td><td><b>${s[0]}</b></td><td>${s[1]}</td></tr>`;
            }
        });

        container.innerHTML += `
            <div class="card">
                <h4>üèÜ ${activeIds[gid]}</h4>
                <table><thead><tr><th>Poz.</th><th>Zawodnik</th><th>Suma</th></tr></thead>
                <tbody id="${bodyId}">${rowsHtml}</tbody>
                </table>
                <button class="btn" style="width:100%; margin-top:5px;" onclick="toggleHofRows('${bodyId}')">${isExp ? 'Poka≈º mniej' : 'Poka≈º wiƒôcej'}</button>
            </div>`;
    }
}

// 3. Funkcje Admina dla Galerii
function updateHofAdminControls() {
    db.ref('global_klasyfikacje').once('value', s => {
        const select = document.getElementById('hof-select-standing');
        select.innerHTML = Object.values(s.val()||{}).map(x => `<option value="${x.name}">${x.name}</option>`).join('');
    });
    db.ref('status/hall_of_fame_tables').on('value', s => {
        const tags = document.getElementById('hof-tags');
        tags.innerHTML = '';
        Object.entries(s.val()||{}).forEach(([id, name]) => {
            tags.innerHTML += `<span class="q-badge" style="background:red; color:white; cursor:pointer;" onclick="db.ref('status/hall_of_fame_tables/${id}').remove()">${name} X</span> `;
        });
    });
}

function addHoFTable() {
    const name = document.getElementById('hof-select-standing').value;
    db.ref('status/hall_of_fame_tables').push(name);
}

function toggleHofRows(id) {
    hofExpanded[id] = !hofExpanded[id];
    renderHallOfFame();
}
function calcResDuet(rid, f, v) {
    if(!isAdmin) return;
    let val = v.trim() === '-' ? '-' : parseFloat(v.replace(',','.')) || 0;
    
    db.ref(`wyniki/${activeCompId}/${rid}`).update({[f]: val}).then(() => {
        db.ref(`wyniki/${activeCompId}/${rid}`).once('value', s => {
            let d = s.val(), sum = 0;
            // Sumujemy noty obu zawodnik√≥w ze wszystkich serii
            const fields = ['s1', 's1_b', 's2', 's2_b', 's3', 's3_b'];
            fields.forEach(x => {
                if(d[x] !== '-' && d[x] !== undefined) sum += parseFloat(d[x] || 0);
            });
            db.ref(`wyniki/${activeCompId}/${rid}`).update({total: sum});
        });
    });
}
function updateManualPB(id, val) {
    db.ref('skoczkowie/' + id).update({ manualPB: parseFloat(val) || 0 });
}
</script>
</script>
</body>
</html>
